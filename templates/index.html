<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–ê–≥–µ–Ω—Ç –ú–∞—Å—Ç–µ—Ä–∞ –∫–ª—é—á–µ–π - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3x-ui</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #242424;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding-bottom: 50px; /* Space for fixed footer */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            margin-top: 5px;
            color: var(--accent);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--bg-tertiary);
        }

        .tab-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Content Area */
        .tab-content {
            display: none;
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .tab-content.active {
            display: block;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input:hover, .form-select:hover {
            border-color: rgba(59, 130, 246, 0.5);
        }

        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a0a0a0' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .form-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #0ea572;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-info {
            background: var(--accent);
            color: white;
        }

        .btn-info:hover {
            background: var(--accent-hover);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        /* Status Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success {
            border-left: 4px solid var(--success);
        }

        .toast-error {
            border-left: 4px solid var(--danger);
        }

        /* Checkbox */
        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        small {
            display: block;
            margin-top: 5px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .page-btn {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 36px;
            text-align: center;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-size-selector label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .page-size-selector select {
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        /* Responsive - Tablet */
        @media (max-width: 1024px) {
            .tabs {
                flex-wrap: wrap;
            }
            .tab-btn {
                flex: 1 1 auto;
                min-width: 100px;
                font-size: 12px;
                padding: 8px 12px;
            }
        }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                padding-bottom: 80px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .tabs {
                gap: 5px;
                padding: 10px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-btn {
                flex: 0 0 auto;
                padding: 8px 12px;
                font-size: 11px;
                white-space: nowrap;
            }

            .btn-group {
                flex-direction: column;
                gap: 8px;
            }

            .btn {
                width: 100%;
                justify-content: center;
                padding: 12px 16px;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                font-size: 12px;
                min-width: 600px;
            }

            th, td {
                padding: 8px 6px;
            }

            .pagination {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .pagination-controls {
                justify-content: center;
            }

            /* SNI Scanner responsive */
            #tab-sni-scanner > div:first-of-type {
                grid-template-columns: 1fr !important;
            }

            .page-size-selector {
                justify-content: center;
            }

            footer {
                padding: 8px 15px !important;
                flex-direction: column;
                gap: 8px;
            }

            footer button {
                width: 100%;
                font-size: 11px !important;
            }

            #version-info {
                font-size: 11px;
            }

            /* Modal mobile optimization */
            [id$="-modal"] > div {
                margin: 10px;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .form-input, .form-select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        /* Responsive - Small Mobile */
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .tab-btn {
                font-size: 10px;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="logout-btn" onclick="logout()">üö™ –í—ã—Ö–æ–¥</button>
            <h1>üîë –ê–≥–µ–Ω—Ç –ú–∞—Å—Ç–µ—Ä–∞ –∫–ª—é—á–µ–π</h1>
            <p style="color: var(--text-secondary)">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ 3x-ui</p>

            <div class="stats-grid" id="stats">
                <div class="stat-card">
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    <div class="stat-value" id="total-users">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                    <div class="stat-value" id="active-users" style="color: var(--success)">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ó–∞–≥—Ä—É–∂–µ–Ω–æ</div>
                    <div class="stat-value" id="total-upload" style="color: var(--warning)">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–°–∫–∞—á–∞–Ω–æ</div>
                    <div class="stat-value" id="total-download" style="color: var(--accent)">-</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="tab-btn" onclick="showTab('bulk-create')">‚ûï –ú–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ</button>
            <button class="tab-btn" onclick="showTab('low-traffic')">üìâ –ù–∏–∑–∫–∏–π —Ç—Ä–∞—Ñ–∏–∫</button>
            <button class="tab-btn" onclick="showTab('unlimited')">‚ôæÔ∏è –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ</button>
            <button class="tab-btn" onclick="showTab('expired')">‚è∞ –ò—Å—Ç–µ–∫—à–∏–µ</button>
            <button class="tab-btn" onclick="showTab('disabled')">üö´ –û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ</button>
            <button class="tab-btn" onclick="showTab('monitoring')">üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
            <button class="tab-btn" onclick="showTab('api-tokens')">üîë API</button>
            <button class="tab-btn" onclick="showTab('inbounds-manage')">üì° Inbounds</button>
            <button class="tab-btn" onclick="showTab('sni-scanner')">üîç SNI</button>
            <button class="tab-btn" onclick="showTab('ssl')">üîê SSL</button>
            <button class="tab-btn" onclick="showTab('xui-control')">‚öôÔ∏è X-UI</button>
            <button class="tab-btn" onclick="showTab('system')">üñ•Ô∏è –°–∏—Å—Ç–µ–º–∞</button>
        </div>

        <!-- Tab: Users -->
        <div id="tab-users" class="tab-content active">
            <h2>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>

            <div class="form-row" style="margin-top: 20px;">
                <div class="form-group">
                    <label class="form-label">–ü–æ–∏—Å–∫ –ø–æ email</label>
                    <input type="text" class="form-input" id="search-users" placeholder="–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –ø–æ–∏—Å–∫–∞...">
                </div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="loadUsers()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn-danger" onclick="deleteSelected()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" class="checkbox" onclick="toggleAllUsers(this)"></th>
                            <th>Email</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–¢—Ä–∞—Ñ–∏–∫</th>
                            <th>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</th>
                            <th>Inbound</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr><td colspan="6" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <div class="pagination-info" id="users-pagination-info">
                    –ü–æ–∫–∞–∑–∞–Ω–æ 0-0 –∏–∑ 0
                </div>
                <div class="pagination-controls">
                    <button class="page-btn" onclick="goToFirstPage()" id="users-first-btn" disabled>‚èÆÔ∏è</button>
                    <button class="page-btn" onclick="goToPrevPage()" id="users-prev-btn" disabled>‚óÄÔ∏è</button>
                    <span id="users-page-numbers" style="display: flex; gap: 5px;"></span>
                    <button class="page-btn" onclick="goToNextPage()" id="users-next-btn">‚ñ∂Ô∏è</button>
                    <button class="page-btn" onclick="goToLastPage()" id="users-last-btn">‚è≠Ô∏è</button>
                </div>
                <div class="page-size-selector">
                    <label>–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
                    <select id="page-size-select" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tab: Bulk Create -->
        <div id="tab-bulk-create" class="tab-content">
            <h2>–ú–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>

            <form onsubmit="bulkCreateUsers(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–ü—Ä–µ—Ñ–∏–∫—Å –∏–º–µ–Ω–∏ *</label>
                        <input type="text" class="form-input" id="bulk-prefix" value="user" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ * <span style="color: #999; font-size: 12px;">(–º–∞–∫—Å. 5000)</span></label>
                        <input type="number" class="form-input" id="bulk-count" min="1" max="5000" value="10" required>
                        <small style="color: var(--text-secondary); font-size: 12px;">–ë–æ–ª–µ–µ 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –æ—á–µ—Ä–µ–¥–µ–π</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–õ–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ (GB) *</label>
                        <input type="number" class="form-input" id="bulk-traffic" value="100" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–¥–Ω–µ–π)</label>
                        <input type="number" class="form-input" id="bulk-expiry-days" value="30" min="0" placeholder="0 = –±–µ—Å—Å—Ä–æ—á–Ω–æ">
                        <small style="color: var(--text-secondary); font-size: 12px;">0 = –±–µ—Å—Å—Ä–æ—á–Ω–æ, > 0 = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Inbound *</label>
                        <select class="form-select" id="bulk-inbound" required onchange="handleInboundChange()">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                        </select>
                    </div>
                    <div class="form-group" id="protocol-field-container">
                        <div id="shadowsocks-fields" style="display: none;">
                            <label class="form-label">–ú–µ—Ç–æ–¥ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (Shadowsocks)</label>
                            <select class="form-select" id="bulk-method">
                                <option value="chacha20-ietf-poly1305">chacha20-ietf-poly1305</option>
                                <option value="aes-256-gcm">aes-256-gcm</option>
                                <option value="aes-128-gcm">aes-128-gcm</option>
                            </select>
                        </div>
                        <div id="vless-fields" style="display: none;">
                            <label class="form-label">Flow (VLESS)</label>
                            <select class="form-select" id="bulk-flow">
                                <option value="">None</option>
                                <option value="xtls-rprx-vision" selected>xtls-rprx-vision</option>
                                <option value="xtls-rprx-vision-udp443">xtls-rprx-vision-udp443</option>
                            </select>
                        </div>
                        <div id="protocol-info" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border); color: var(--text-secondary); font-size: 13px;">
                            <span id="protocol-name">–í—ã–±–µ—Ä–∏—Ç–µ inbound</span>
                        </div>
                    </div>
                </div>

                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="bulk-all-inbounds" class="checkbox" onchange="toggleMultiInboundSelection()">
                            <span style="font-weight: 500;">–°–æ–∑–¥–∞—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö inbounds</span>
                        </label>
                        <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 4px;">
                            –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö inbound'–∞—Ö —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º email
                        </small>

                        <!-- –í—ã–±–æ—Ä –∏–Ω–±–∞—É–Ω–¥–æ–≤ -->
                        <div id="multi-inbound-selector" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                            <div style="margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" id="select-all-inbounds" onchange="toggleAllInbounds()" checked>
                                    <span style="font-weight: 600;">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</span>
                                </label>
                            </div>
                            <div id="inbounds-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-top: 8px;">
                                <!-- –°–ø–∏—Å–æ–∫ –∏–Ω–±–∞—É–Ω–¥–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                            <small id="multi-inbound-info" style="color: var(--success); font-size: 12px; display: block; margin-top: 8px;">
                                –í—ã–±—Ä–∞–Ω–æ: <span id="selected-inbounds-count">0</span> –∏–Ω–±–∞—É–Ω–¥–æ–≤
                            </small>
                        </div>

                        <small id="multi-inbound-limit-warning" style="color: var(--warning); font-size: 12px; display: none; margin-top: 8px;">
                            ‚ö†Ô∏è –ú–∞–∫—Å. 1000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ 5000 –æ–ø–µ—Ä–∞—Ü–∏–π (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ √ó inbounds)
                        </small>
                    </div>
                </div>

                <button type="submit" class="btn btn-success">‚ú® –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
            </form>

            <h3 style="margin-top: 40px;">–ê–∫—Ç–∏–≤–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID –æ—á–µ—Ä–µ–¥–∏</th>
                            <th>–ò–Ω–±–∞—É–Ω–¥</th>
                            <th>–ü—Ä–æ—Ç–æ–∫–æ–ª</th>
                            <th>–ü—Ä–µ—Ñ–∏–∫—Å</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–°–æ–∑–¥–∞–Ω–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="queues-table-body">
                        <tr><td colspan="9" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—á–µ—Ä–µ–¥–µ–π...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Low Traffic -->
        <div id="tab-low-traffic" class="tab-content">
            <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –Ω–∏–∑–∫–∏–º —Ç—Ä–∞—Ñ–∏–∫–æ–º</h2>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">–ü–æ—Ä–æ–≥ —Ç—Ä–∞—Ñ–∏–∫–∞ (–±–∞–π—Ç)</label>
                    <input type="number" class="form-input" id="low-traffic-threshold" value="1024" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                    <select class="form-select" id="low-traffic-sort">
                        <option value="remaining">–ü–æ –æ—Å—Ç–∞—Ç–∫—É</option>
                        <option value="used">–ü–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–º—É</option>
                        <option value="email">–ü–æ email</option>
                    </select>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="loadLowTrafficUsers()">üîç –ù–∞–π—Ç–∏</button>
                <button class="btn btn-secondary" onclick="resetTrafficSelected()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫</button>
                <button class="btn btn-danger" onclick="deleteLowTrafficSelected()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" class="checkbox" onclick="toggleAllLowTraffic(this)"></th>
                            <th>Email</th>
                            <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>
                            <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                            <th>–õ–∏–º–∏—Ç</th>
                        </tr>
                    </thead>
                    <tbody id="low-traffic-table-body">
                        <tr><td colspan="5" class="loading">–ù–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏" –¥–ª—è –ø–æ–∏—Å–∫–∞</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Unlimited -->
        <div id="tab-unlimited" class="tab-content">
            <h2>–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º –±–µ–∑–ª–∏–º–∏—Ç–∞ (–≤—Ä–µ–º—è, —Ç—Ä–∞—Ñ–∏–∫ –∏–ª–∏ –æ–±–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞)
            </p>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞ <span style="color: #999; font-size: 12px;">(–≤—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏–π –ø–æ–∏—Å–∫–∞)</span></label>
                    <select class="form-select" id="unlimited-filter-type" onchange="updateFilterDescription()">
                        <option value="expiry">–ë–µ—Å—Å—Ä–æ—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–±–µ–∑ –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è)</option>
                        <option value="traffic">–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ (–Ω–µ—Ç –ª–∏–º–∏—Ç–∞ —Ç—Ä–∞—Ñ–∏–∫–∞)</option>
                        <option value="both">–û–±–∞ –∫—Ä–∏—Ç–µ—Ä–∏—è (–±–µ—Å—Å—Ä–æ—á–Ω—ã–µ –ò –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫)</option>
                    </select>
                    <small id="filter-description" style="display: block; margin-top: 8px; color: #0066cc; font-size: 13px;">
                        üìå –ë—É–¥—É—Ç –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (expiry_time = 0)
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">–ú–∞–∫—Å. —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ <span style="color: #999; font-size: 12px;">(0 = –≤—Å–µ)</span></label>
                    <input type="number" class="form-input" id="unlimited-limit" value="100" min="0" max="10000">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü—Ä–æ–¥–ª–∏—Ç—å –Ω–∞ (–¥–Ω–µ–π)</label>
                    <input type="number" class="form-input" id="unlimited-extend-days" value="30" min="1">
                </div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="loadUnlimitedUsers()">üîç –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
                <button class="btn btn-success" onclick="extendUnlimitedExpiry()">üìÖ –ü—Ä–æ–¥–ª–∏—Ç—å —Å—Ä–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º</button>
                <button class="btn btn-secondary" onclick="resetTrafficUnlimited()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫</button>
                <button class="btn btn-info" onclick="addTrafficUnlimited()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫</button>
                <button class="btn btn-warning" onclick="setLimitUnlimited()">üìä –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç</button>
                <button class="btn btn-danger" onclick="blockUnlimitedSelected()">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
            </div>

            <!-- Status bar showing filter and results -->
            <div id="unlimited-status-bar" style="display: none; margin: 20px 0; padding: 12px; background: #e8f4fd; border-left: 4px solid #0066cc; border-radius: 4px;">
                <strong>–ê–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä:</strong> <span id="unlimited-active-filter"></span> |
                <strong>–ù–∞–π–¥–µ–Ω–æ:</strong> <span id="unlimited-results-count">0</span> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" class="checkbox" onclick="toggleAllUnlimited(this)"></th>
                            <th>Email</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>
                            <th>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="unlimited-table-body">
                        <tr><td colspan="5" class="loading">
                            –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Expired Users -->
        <div id="tab-expired" class="tab-content">
            <h2>–ò—Å—Ç–µ–∫—à–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
            </p>

            <div class="btn-group" style="margin-top: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="loadExpiredUsers()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <button class="btn btn-success" onclick="showExtendExpiredModal()">‚úÖ –ü—Ä–æ–¥–ª–∏—Ç—å –∏ –≤–∫–ª—é—á–∏—Ç—å</button>
                <button class="btn btn-danger" onclick="deleteExpiredSelected()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
                <button class="btn btn-warning" onclick="deleteAllExpired()">‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –∏—Å—Ç–µ–∫—à–∏—Ö</button>
            </div>

            <!-- Extend Expired Modal -->
            <div id="extend-expired-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-secondary); padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
                    <h3 style="margin-top: 0;">–ü—Ä–æ–¥–ª–∏—Ç—å –∏ –≤–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è</p>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–¥–Ω–µ–π)</label>
                        <input type="number" class="form-input" id="extend-expiry-days" value="30" min="1">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">–°–±—Ä–æ—Å–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫</label>
                        <select class="form-input" id="extend-reset-traffic">
                            <option value="no">–ù–µ—Ç</option>
                            <option value="yes">–î–∞</option>
                        </select>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="extendExpiredUsers()">‚úÖ –ü—Ä–æ–¥–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
                        <button class="btn btn-warning" onclick="extendAllExpiredUsers()">‚ö° –ü—Ä–æ–¥–ª–∏—Ç—å –≤—Å–µ—Ö</button>
                        <button class="btn btn-secondary" onclick="closeExtendExpiredModal()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>

            <div class="table-container" style="margin-top: 20px;">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" class="checkbox" onclick="toggleAllExpired(this)"></th>
                            <th>Email</th>
                            <th>Inbound ID</th>
                            <th>–ò—Å—Ç–µ–∫</th>
                            <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody id="expired-table-body">
                        <tr><td colspan="6" class="loading">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Disabled Users -->
        <div id="tab-disabled" class="tab-content">
            <h2>–û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–º (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º) —Å—Ç–∞—Ç—É—Å–æ–º
            </p>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="loadDisabledUsers()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <button class="btn btn-danger" onclick="deleteDisabledSelected()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
                <button class="btn btn-warning" onclick="deleteAllDisabled()">‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö</button>
                <button class="btn btn-success" onclick="showEnableModal()">‚úÖ –í–∫–ª—é—á–∏—Ç—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏</button>
            </div>

            <!-- Enable Users Modal -->
            <div id="enable-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-secondary); padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
                    <h3 style="margin-top: 0;">–í–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤–∫–ª—é—á–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–¥–Ω–µ–π)</label>
                        <input type="number" class="form-input" id="enable-expiry-days" value="30" min="0">
                        <small style="color: var(--text-secondary); font-size: 12px;">0 = –±–µ—Å—Å—Ä–æ—á–Ω–æ</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">–õ–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ (GB)</label>
                        <input type="number" class="form-input" id="enable-traffic-gb" value="100" min="0">
                        <small style="color: var(--text-secondary); font-size: 12px;">0 = –±–µ–∑–ª–∏–º–∏—Ç</small>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeEnableModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-success" onclick="confirmEnableUsers()">‚úÖ –í–∫–ª—é—á–∏—Ç—å</button>
                    </div>
                </div>
            </div>

            <div class="table-container" style="margin-top: 20px;">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" class="checkbox" onclick="toggleAllDisabled(this)"></th>
                            <th>Email</th>
                            <th>Inbound ID</th>
                            <th>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</th>
                            <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>
                        </tr>
                    </thead>
                    <tbody id="disabled-table-body">
                        <tr><td colspan="5" class="loading">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Update Progress Modal -->
        <div id="update-progress-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
            <div style="background: var(--bg-secondary); padding: 40px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                <h3 style="margin-top: 0; text-align: center;">üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</h3>

                <div id="update-progress-stage" style="text-align: center; margin: 20px 0; font-size: 16px; color: var(--accent); font-weight: 500;">
                    –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...
                </div>

                <!-- Progress Bar -->
                <div style="background: var(--bg-primary); height: 30px; border-radius: 15px; margin: 20px 0; overflow: hidden; position: relative;">
                    <div id="update-progress-bar" style="background: linear-gradient(90deg, var(--accent), var(--success)); height: 100%; width: 0%; transition: width 0.5s; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                        0%
                    </div>
                </div>

                <div id="update-progress-message" style="text-align: center; color: var(--text-secondary); font-size: 14px; min-height: 40px; margin: 15px 0;">
                    –ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...
                </div>

                <div id="update-success-message" style="display: none; text-align: center; color: var(--success); font-size: 16px; margin: 20px 0; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                    ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!<br>
                    <small style="font-size: 13px;">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ <span id="reload-countdown">5</span> —Å–µ–∫...</small>
                </div>

                <div id="update-error-message" style="display: none; text-align: center; color: var(--danger); font-size: 14px; margin: 20px 0; padding: 15px; background: rgba(244, 67, 54, 0.1); border-radius: 8px; white-space: pre-wrap;">
                </div>

                <div style="text-align: center; margin-top: 25px;">
                    <button id="close-update-modal-btn" class="btn btn-secondary" onclick="closeUpdateModal()" style="display: none;">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: var(--bg-primary); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
                    <strong>‚ÑπÔ∏è –í–∞–∂–Ω–æ:</strong> –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ –∏ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
                </div>
            </div>
        </div>

        <!-- SSL Renewal Progress Modal -->
        <div id="ssl-progress-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
            <div style="background: var(--bg-secondary); padding: 40px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                <h3 style="margin-top: 0; text-align: center;">üîê –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</h3>
                <div id="ssl-progress-message" style="text-align: center; margin: 20px 0; font-size: 16px; color: var(--accent);">
                    –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞...
                </div>
                <div id="ssl-success-message" style="display: none; text-align: center; color: var(--success); font-size: 16px; margin: 20px 0; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                </div>
                <div id="ssl-error-message" style="display: none; text-align: center; color: var(--danger); font-size: 14px; margin: 20px 0; padding: 15px; background: rgba(244, 67, 54, 0.1); border-radius: 8px;">
                </div>
                <div style="text-align: center; margin-top: 25px;">
                    <button id="close-ssl-modal-btn" class="btn btn-secondary" onclick="closeSSLModal()" style="display: none;">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab: SNI Scanner -->
        <div id="tab-sni-scanner" class="tab-content">
            <h2>üîç SNI Scanner –¥–ª—è Reality</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                –ü–æ–∏—Å–∫ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è Reality SNI (TLS 1.3 + H2)
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- Single Domain Test -->
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                    <h3 style="margin-top: 0; font-size: 16px;">–¢–µ—Å—Ç –æ–¥–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" class="form-input" id="sni-single-domain" placeholder="example.com" style="flex: 1;">
                        <button class="btn btn-primary" onclick="testSingleSNI()">üîç –¢–µ—Å—Ç</button>
                    </div>
                    <div id="sni-single-result" style="font-size: 13px; color: var(--text-secondary);"></div>
                </div>

                <!-- Saved Domains -->
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                    <h3 style="margin-top: 0; font-size: 16px;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã</h3>
                    <div id="sni-saved-list" style="max-height: 150px; overflow-y: auto; font-size: 13px;">
                        <span style="color: var(--text-secondary);">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤</span>
                    </div>
                </div>
            </div>

            <!-- Auto Discovery -->
            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; font-size: 16px;">üîé –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ SNI</h3>
                <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 15px;">
                    –°–∫–∞–Ω–∏—Ä—É–µ—Ç IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã CDN –∏ –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–æ–º–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <select class="form-input" id="sni-provider" style="width: auto; min-width: 140px;">
                        <option value="local">üè† –õ–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Ç—å</option>
                        <option value="all">üåê –í—Å–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã</option>
                        <option value="cloudflare">Cloudflare</option>
                        <option value="google">Google</option>
                        <option value="amazon">Amazon</option>
                        <option value="microsoft">Microsoft</option>
                        <option value="fastly">Fastly</option>
                    </select>
                    <input type="number" class="form-input" id="sni-discover-count" value="20" min="5" max="50" style="width: 70px;" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                    <button class="btn btn-success" onclick="discoverSNI()">üöÄ –ù–∞–π—Ç–∏</button>
                </div>
            </div>

            <!-- Manual Bulk Scan -->
            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; font-size: 16px;">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ–º–µ–Ω–æ–≤</h3>
                <div class="btn-group" style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="loadSNISuggestions()">üìã –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</button>
                    <button class="btn btn-primary" onclick="scanSNIDomains()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
                <textarea class="form-input" id="sni-domains-list" rows="3" placeholder="–î–æ–º–µ–Ω—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)" style="font-family: monospace; font-size: 12px;"></textarea>
            </div>

            <!-- Scan Results -->
            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                <h3 style="margin-top: 0; font-size: 16px;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                <div class="table-container">
                    <table id="sni-results-table">
                        <thead>
                            <tr>
                                <th>–î–æ–º–µ–Ω</th>
                                <th>TLS 1.3</th>
                                <th>H2</th>
                                <th>Latency</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="sni-results-body">
                            <tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-secondary);">–ù–∞–∂–º–∏—Ç–µ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" –¥–ª—è –Ω–∞—á–∞–ª–∞</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: SSL Certificate Management -->
        <div id="tab-ssl" class="tab-content">
            <h2>üîê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º Let's Encrypt –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 3x-ui
            </p>

            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-label">–î–æ–º–µ–Ω</div>
                    <div class="stat-value" id="ssl-domain" style="font-size: 18px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–°—Ç–∞—Ç—É—Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</div>
                    <div class="stat-value" id="ssl-status" style="font-size: 18px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–î–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è</div>
                    <div class="stat-value" id="ssl-days-left" style="font-size: 24px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ò—Å—Ç–µ–∫–∞–µ—Ç</div>
                    <div class="stat-value" id="ssl-expiry-date" style="font-size: 16px;">-</div>
                </div>
            </div>

            <div class="btn-group" style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="loadSSLStatus()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                <button class="btn btn-success" onclick="renewSSLCertificate(false)">üîê –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</button>
                <button class="btn btn-warning" onclick="renewSSLCertificate(true)">‚ö° –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
            </div>

            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                <div class="btn-group" style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="update3xuiCertificate()">üìã –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ 3x-ui</button>
                    <button class="btn btn-secondary" onclick="restartSSLServices()">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã</button>
                </div>
                <p style="color: #888; font-size: 12px; margin-top: 15px; margin-bottom: 0;">
                    ‚ÑπÔ∏è "–û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ 3x-ui" - –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—É—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –≤ –ø–∞–Ω–µ–ª–∏ 3x-ui –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∞–º–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.<br>
                    ‚ÑπÔ∏è "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã" - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç Nginx –∏ 3x-ui –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.
                </p>
            </div>

            <div id="ssl-info-details" style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                <h3 style="margin-top: 0;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ</h3>
                <div id="ssl-cert-details" style="font-family: monospace; font-size: 13px; color: var(--text-secondary);">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...
                </div>
            </div>
        </div>

        <!-- Tab: Inbounds Management -->
        <div id="tab-inbounds-manage" class="tab-content">
            <h2>üì° –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Inbounds</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                –ü—Ä–æ—Å–º–æ—Ç—Ä, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ inbounds
            </p>

            <div class="btn-group" style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="loadInboundsTable()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>

            <div class="table-container">
                <table id="inbounds-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ü—Ä–æ—Ç–æ–∫–æ–ª</th>
                            <th>–ü–æ—Ä—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="inbounds-table-body">
                        <tr><td colspan="7" style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Inbound Edit Modal -->
        <div id="inbound-edit-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 id="inbound-modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å Inbound</h3>
                    <button class="modal-close" onclick="closeInboundModal()">&times;</button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <input type="hidden" id="edit-inbound-id">

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" class="form-input" id="edit-inbound-remark">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü–æ—Ä—Ç</label>
                            <input type="number" class="form-input" id="edit-inbound-port">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ü—Ä–æ—Ç–æ–∫–æ–ª</label>
                            <input type="text" class="form-input" id="edit-inbound-protocol" readonly style="background: var(--bg-tertiary);">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                            <select class="form-input" id="edit-inbound-enable">
                                <option value="1">–í–∫–ª—é—á–µ–Ω</option>
                                <option value="0">–í—ã–∫–ª—é—á–µ–Ω</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Stream Settings (JSON)</label>
                        <textarea class="form-input" id="edit-inbound-stream" rows="8" style="font-family: monospace; font-size: 12px;"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Settings (JSON)</label>
                        <textarea class="form-input" id="edit-inbound-settings" rows="6" style="font-family: monospace; font-size: 12px;"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Sniffing (JSON)</label>
                        <textarea class="form-input" id="edit-inbound-sniffing" rows="4" style="font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeInboundModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-primary" onclick="saveInbound()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Tab: X-UI Control -->
        <div id="tab-xui-control" class="tab-content">
            <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ X-UI</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π x-ui, –ª–æ–≥–∏ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
            </p>

            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-label">–°—Ç–∞—Ç—É—Å X-UI</div>
                    <div class="stat-value" id="xui-service-status" style="font-size: 16px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–í–µ—Ä—Å–∏—è X-UI</div>
                    <div class="stat-value" id="xui-version" style="font-size: 14px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–í–µ—Ä—Å–∏—è Xray</div>
                    <div class="stat-value" id="xray-version" style="font-size: 14px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π</div>
                    <div class="stat-value" id="tcp-connections" style="font-size: 16px;">-</div>
                </div>
            </div>

            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π</h3>
                <div class="btn-group" style="flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="xuiAction('restart')">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
                    <button class="btn btn-warning" onclick="xuiAction('stop')">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button class="btn btn-primary" onclick="xuiAction('start')">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                    <button class="btn btn-secondary" onclick="loadXuiStatus()">üìä –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button class="btn btn-primary" onclick="openPanel()" id="panel-link-btn">üîó –ü–∞–Ω–µ–ª—å</button>
                </div>
            </div>

            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0;">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
                <div class="btn-group" style="flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="runSpeedtest()">üöÄ Speedtest</button>
                    <button class="btn btn-warning" onclick="regenerateKeys()">üîë –ù–æ–≤—ã–µ –∫–ª—é—á–∏</button>
                    <button class="btn btn-success" onclick="applySNI()">üì° –ü—Ä–∏–º–µ–Ω–∏—Ç—å SNI</button>
                </div>
                <div id="speedtest-result" style="font-size: 12px; color: var(--text-secondary);"></div>
            </div>

            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0;">–õ–æ–≥–∏ X-UI</h3>
                <div class="btn-group" style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="loadXuiLogs('info')">üìÑ –û—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏</button>
                    <button class="btn btn-danger" onclick="loadXuiLogs('error')">‚ùå –û—à–∏–±–∫–∏</button>
                    <button class="btn btn-secondary" onclick="clearXuiLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <pre id="xui-logs" style="background: var(--bg-primary); padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-size: 12px; white-space: pre-wrap; word-break: break-all;">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤...</pre>
            </div>

            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h3>
                <div class="btn-group" style="flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="updateDatFiles()">üåç –û–±–Ω–æ–≤–∏—Ç—å GeoIP/GeoSite</button>
                    <button class="btn btn-warning" onclick="updateXray()">‚¨ÜÔ∏è –û–±–Ω–æ–≤–∏—Ç—å Xray</button>
                </div>
                <p style="color: #888; font-size: 12px; margin-top: 15px; margin-bottom: 0;">
                    GeoIP/GeoSite - –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º (–†–æ—Å—Å–∏—è, –ò—Ä–∞–Ω –∏ –¥—Ä.)
                </p>
            </div>

            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                <h3 style="margin-top: 0;">Fingerprint (TLS/Reality)</h3>
                <p style="color: #888; font-size: 12px; margin-bottom: 15px;">
                    –û–±–Ω–æ–≤–∏—Ç—å fingerprint –Ω–∞ –≤—Å–µ—Ö inbounds —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π TLS/Reality
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <select id="fingerprint-select" style="padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); min-width: 150px;">
                        <option value="randomized">randomized</option>
                        <option value="random">random</option>
                        <option value="chrome">chrome</option>
                        <option value="firefox">firefox</option>
                        <option value="safari">safari</option>
                        <option value="ios">ios</option>
                        <option value="android">android</option>
                        <option value="edge">edge</option>
                        <option value="360">360</option>
                        <option value="qq">qq</option>
                    </select>
                    <button class="btn btn-primary" onclick="updateFingerprints()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-secondary" onclick="loadFingerprints()">üìã –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ</button>
                </div>
                <div id="fingerprint-info" style="margin-top: 15px; font-size: 12px; color: var(--text-secondary);"></div>
            </div>
        </div>

        <!-- Tab: System Optimization -->
        <div id="tab-system" class="tab-content">
            <h2>üñ•Ô∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π —Å–µ—Ä–≤–µ—Ä–∞
            </p>

            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-label">BBR</div>
                    <div class="stat-value" id="bbr-status" style="font-size: 16px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">TCP Optimization</div>
                    <div class="stat-value" id="tcp-status" style="font-size: 16px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Kernel</div>
                    <div class="stat-value" id="kernel-version" style="font-size: 14px;">-</div>
                </div>
            </div>

            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0;">–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π</h3>
                <div class="btn-group" style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="checkSystemOptimization()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É</button>
                </div>
                <div id="system-check-results" style="font-family: monospace; font-size: 13px; color: var(--text-secondary);">
                    –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É" –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                </div>
            </div>

            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                <h3 style="margin-top: 0;">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π</h3>
                <div class="btn-group" style="flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="installBBR()">üöÄ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å BBR3</button>
                    <button class="btn btn-primary" onclick="optimizeTCP()">‚ö° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å TCP</button>
                    <button class="btn btn-warning" onclick="installAllOptimizations()">üîß –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë</button>
                </div>
                <p style="color: #888; font-size: 12px; margin-top: 15px; margin-bottom: 0;">
                    ‚ö†Ô∏è BBR3 —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
                </p>
            </div>
        </div>

        <!-- Tab: Monitoring -->
        <div id="tab-monitoring" class="tab-content">
            <h2>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–∞</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
            </p>

            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-label">–û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    <div class="stat-value" id="online-users-count" style="color: var(--success)">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ó–∞–≥—Ä—É–∑–∫–∞ CPU</div>
                    <div class="stat-value" id="cpu-usage">-</div>
                    <div style="background: var(--bg-primary); height: 6px; border-radius: 3px; margin-top: 8px; overflow: hidden;">
                        <div id="cpu-bar" style="background: var(--accent); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ü–∞–º—è—Ç—å</div>
                    <div class="stat-value" id="memory-usage">-</div>
                    <div style="background: var(--bg-primary); height: 6px; border-radius: 3px; margin-top: 8px; overflow: hidden;">
                        <div id="memory-bar" style="background: var(--success); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–î–∏—Å–∫</div>
                    <div class="stat-value" id="disk-usage">-</div>
                    <div style="background: var(--bg-primary); height: 6px; border-radius: 3px; margin-top: 8px; overflow: hidden;">
                        <div id="disk-bar" style="background: var(--warning); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–°–µ—Ç—å (–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ)</div>
                    <div class="stat-value" id="network-sent" style="font-size: 20px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–°–µ—Ç—å (–ø–æ–ª—É—á–µ–Ω–æ)</div>
                    <div class="stat-value" id="network-recv" style="font-size: 20px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</div>
                    <div class="stat-value" id="server-uptime" style="font-size: 20px;">-</div>
                </div>
            </div>

            <div style="text-align: center; color: #666; font-size: 13px;">
                –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            </div>
        </div>

        <!-- Tab: API Tokens -->
        <div id="tab-api-tokens" class="tab-content">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –¢–æ–∫–µ–Ω–∞–º–∏</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                –°–æ–∑–¥–∞–≤–∞–π—Ç–µ API —Ç–æ–∫–µ–Ω—ã –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ API. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫: <code>Authorization: Bearer &lt;token&gt;</code>
            </p>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞</label>
                    <input type="text" class="form-input" id="token-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Production Server">
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="generateToken()">üîë –°–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω</button>
                </div>
            </div>

            <!-- Token display modal -->
            <div id="token-display" style="display: none; margin: 20px 0; padding: 20px; background: #e8f4fd; border-left: 4px solid #0066cc; border-radius: 4px;">
                <strong>‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!</strong>
                <p style="margin: 10px 0; color: #c33;">‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ. –û–Ω –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω!</p>
                <div style="background: white; padding: 12px; border-radius: 4px; margin: 10px 0; font-family: monospace; word-break: break-all;">
                    <span id="new-token-value"></span>
                </div>
                <button class="btn btn-secondary" onclick="copyToken()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-success" onclick="closeTokenDisplay()">‚úÖ –ü–æ–Ω—è—Ç–Ω–æ, —Å–æ—Ö—Ä–∞–Ω–∏–ª</button>
            </div>

            <h3 style="margin-top: 30px;">–ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–¢–æ–∫–µ–Ω (–Ω–∞—á–∞–ª–æ)</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                            <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="tokens-table-body">
                        <tr><td colspan="6" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Footer with Version and Update Button -->
    <footer style="
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border);
        color: var(--text-primary);
        padding: 8px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
        font-size: 13px;
    ">
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="version-info">‚öôÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ä—Å–∏–∏...</span>
        </div>
        <div id="update-buttons" style="display: none; align-items: center; gap: 10px;">
            <span id="update-status" style="color: var(--success); font-size: 12px;"></span>
            <button id="perform-update-btn" onclick="performUpdate()" style="
                background: var(--success);
                border: none;
                color: white;
                padding: 5px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                font-weight: 600;
                transition: all 0.3s;
            ">
                ‚¨ÜÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –¥–æ <span id="new-version"></span>
            </button>
        </div>
    </footer>

    <script>
        // Use relative URLs - nginx proxies /manager/ to API service
        const API_URL = '';
        let currentUsers = [];
        let lowTrafficUsers = [];
        let unlimitedUsers = [];

        // Pagination variables
        let currentPage = 1;
        let pageSize = 50;
        let totalUsers = 0;

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');

            // Handle tab-specific actions
            if (tabName === 'api-tokens') {
                loadTokens();
                stopMonitoring();
                stopQueuePolling();
            } else if (tabName === 'monitoring') {
                startMonitoring();
                stopQueuePolling();
            } else if (tabName === 'bulk-create') {
                startQueuePolling();
                stopMonitoring();
            } else {
                stopMonitoring();
                stopQueuePolling();
            }
        }

        // Toast notifications
        function showToast(message, type) {
            type = type || 'success';
            const toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(function() { toast.remove(); }, 3000);
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch('api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    window.location.href = 'login';
                } else {
                    showToast('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞', 'error');
                }
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'login';
            }
        }

        // Format bytes
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            var k = 1024;
            var sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        // Format date
        function formatDate(timestamp) {
            if (!timestamp || timestamp === 0) return '–ë–µ—Å—Å—Ä–æ—á–Ω–æ';
            var date = new Date(timestamp);
            return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
        }

        // Load stats
        function loadStats() {
            fetch(API_URL + 'api/stats')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    document.getElementById('total-users').textContent = data.total_users || 0;
                    document.getElementById('active-users').textContent = data.active_users || 0;
                    document.getElementById('total-upload').textContent = formatBytes(data.total_upload || 0);
                    document.getElementById('total-download').textContent = formatBytes(data.total_download || 0);
                })
                .catch(function(error) {
                    console.error('Error loading stats:', error);
                });
        }

        // Store inbounds data globally
        let inboundsData = [];

        // Load inbounds
        function loadInbounds() {
            fetch(API_URL + 'api/inbounds')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    inboundsData = data.inbounds;
                    var select = document.getElementById('bulk-inbound');
                    select.innerHTML = data.inbounds.map(function(inbound) {
                        return '<option value="' + inbound.id + '" data-protocol="' + inbound.protocol + '">' +
                               inbound.remark + ' (' + inbound.protocol + ':' + inbound.port + ')</option>';
                    }).join('');

                    // Trigger change event to show appropriate fields
                    if (data.inbounds.length > 0) {
                        handleInboundChange();
                    }
                })
                .catch(function(error) {
                    console.error('Error loading inbounds:', error);
                });
        }

        // Handle inbound selection change
        function handleInboundChange() {
            var select = document.getElementById('bulk-inbound');
            var selectedId = parseInt(select.value);

            if (!selectedId) {
                document.getElementById('shadowsocks-fields').style.display = 'none';
                document.getElementById('vless-fields').style.display = 'none';
                document.getElementById('protocol-info').style.display = 'block';
                document.getElementById('protocol-name').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ inbound';
                return;
            }

            var selectedInbound = inboundsData.find(function(inbound) {
                return inbound.id === selectedId;
            });

            if (!selectedInbound) return;

            var protocol = selectedInbound.protocol.toLowerCase();

            // Hide all protocol-specific fields first
            document.getElementById('shadowsocks-fields').style.display = 'none';
            document.getElementById('vless-fields').style.display = 'none';
            document.getElementById('protocol-info').style.display = 'block';

            // Show fields based on protocol
            if (protocol === 'shadowsocks') {
                document.getElementById('shadowsocks-fields').style.display = 'block';
                document.getElementById('protocol-info').style.display = 'none';
            } else if (protocol === 'vless') {
                document.getElementById('vless-fields').style.display = 'block';
                document.getElementById('protocol-info').style.display = 'none';
            } else if (protocol === 'vmess') {
                document.getElementById('protocol-name').innerHTML = '‚úÖ <strong>VMess</strong>: UUID –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';
            } else if (protocol === 'trojan') {
                document.getElementById('protocol-name').innerHTML = '‚úÖ <strong>Trojan</strong>: –ü–∞—Ä–æ–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';
            } else {
                document.getElementById('protocol-name').innerHTML = '‚úÖ –ü—Ä–æ—Ç–æ–∫–æ–ª: <strong>' + protocol.toUpperCase() + '</strong>';
            }
        }

        // Load users
        function loadUsers() {
            var search = document.getElementById('search-users').value;
            var offset = (currentPage - 1) * pageSize;
            var url = API_URL + 'api/users?limit=' + pageSize + '&offset=' + offset;
            if (search) url += '&search=' + search;

            fetch(url)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    currentUsers = data.users;
                    totalUsers = data.total;

                    var tbody = document.getElementById('users-table-body');
                    if (currentUsers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="loading">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
                        updatePagination();
                        return;
                    }

                    tbody.innerHTML = currentUsers.map(function(user) {
                        return '<tr>' +
                            '<td><input type="checkbox" class="checkbox user-checkbox" value="' + user.id + '"></td>' +
                            '<td>' + user.email + '</td>' +
                            '<td><span class="badge ' + (user.enable ? 'badge-success' : 'badge-danger') + '">' + (user.enable ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω') + '</span></td>' +
                            '<td>' + formatBytes(user.up + user.down) + ' / ' + formatBytes(user.total) + '</td>' +
                            '<td>' + formatDate(user.expiry_time) + '</td>' +
                            '<td>' + (user.inbound_name || '-') + '</td>' +
                            '</tr>';
                    }).join('');

                    updatePagination();
                })
                .catch(function(error) {
                    console.error('Error loading users:', error);
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                });
        }

        // Pagination functions
        function updatePagination() {
            var totalPages = Math.ceil(totalUsers / pageSize);
            var startItem = totalUsers === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            var endItem = Math.min(currentPage * pageSize, totalUsers);

            // Update info text
            document.getElementById('users-pagination-info').textContent =
                '–ü–æ–∫–∞–∑–∞–Ω–æ ' + startItem + '-' + endItem + ' –∏–∑ ' + totalUsers;

            // Update navigation buttons
            document.getElementById('users-first-btn').disabled = currentPage === 1;
            document.getElementById('users-prev-btn').disabled = currentPage === 1;
            document.getElementById('users-next-btn').disabled = currentPage >= totalPages;
            document.getElementById('users-last-btn').disabled = currentPage >= totalPages;

            // Render page numbers
            renderPageNumbers(totalPages);
        }

        function renderPageNumbers(totalPages) {
            var container = document.getElementById('users-page-numbers');
            var html = '';
            var maxVisible = 5;
            var start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            var end = Math.min(totalPages, start + maxVisible - 1);

            if (end - start < maxVisible - 1) {
                start = Math.max(1, end - maxVisible + 1);
            }

            if (start > 1) {
                html += '<button class="page-btn" onclick="goToPage(1)">1</button>';
                if (start > 2) {
                    html += '<span style="color: var(--text-secondary); padding: 0 5px;">...</span>';
                }
            }

            for (var i = start; i <= end; i++) {
                html += '<button class="page-btn ' + (i === currentPage ? 'active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</button>';
            }

            if (end < totalPages) {
                if (end < totalPages - 1) {
                    html += '<span style="color: var(--text-secondary); padding: 0 5px;">...</span>';
                }
                html += '<button class="page-btn" onclick="goToPage(' + totalPages + ')">' + totalPages + '</button>';
            }

            container.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadUsers();
        }

        function goToFirstPage() {
            goToPage(1);
        }

        function goToPrevPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }

        function goToNextPage() {
            var totalPages = Math.ceil(totalUsers / pageSize);
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        }

        function goToLastPage() {
            var totalPages = Math.ceil(totalUsers / pageSize);
            goToPage(totalPages);
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('page-size-select').value);
            currentPage = 1;
            loadUsers();
        }

        // Toggle multi-inbound selection UI
        function toggleMultiInboundSelection() {
            var checkbox = document.getElementById('bulk-all-inbounds');
            var selector = document.getElementById('multi-inbound-selector');
            var warning = document.getElementById('multi-inbound-limit-warning');

            if (checkbox.checked) {
                selector.style.display = 'block';
                warning.style.display = 'block';
                loadInboundsCheckboxes();
            } else {
                selector.style.display = 'none';
                warning.style.display = 'none';
            }
        }

        // Load inbounds as checkboxes
        function loadInboundsCheckboxes() {
            var container = document.getElementById('inbounds-checkboxes');
            container.innerHTML = '';

            inboundsData.forEach(function(inbound) {
                var label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px; padding: 6px; border-radius: 4px; background: var(--bg-secondary);';

                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = inbound.id;
                checkbox.className = 'inbound-checkbox';
                checkbox.checked = true;
                checkbox.onchange = updateSelectedInboundsCount;

                var protocolBadge = '';
                if (inbound.protocol === 'vless') protocolBadge = 'üîµ VLESS';
                else if (inbound.protocol === 'vmess') protocolBadge = 'üü¢ VMess';
                else if (inbound.protocol === 'trojan') protocolBadge = 'üî¥ Trojan';
                else if (inbound.protocol === 'shadowsocks') protocolBadge = 'üü£ SS';
                else protocolBadge = '‚ö™ ' + inbound.protocol;

                var span = document.createElement('span');
                span.textContent = protocolBadge + ' - ' + inbound.remark + ' (:' + inbound.port + ')';

                label.appendChild(checkbox);
                label.appendChild(span);
                container.appendChild(label);
            });

            updateSelectedInboundsCount();
        }

        // Toggle all inbounds checkboxes
        function toggleAllInbounds() {
            var selectAll = document.getElementById('select-all-inbounds');
            var checkboxes = document.querySelectorAll('.inbound-checkbox');

            checkboxes.forEach(function(checkbox) {
                checkbox.checked = selectAll.checked;
            });

            updateSelectedInboundsCount();
        }

        // Update selected inbounds counter
        function updateSelectedInboundsCount() {
            var checkboxes = document.querySelectorAll('.inbound-checkbox:checked');
            var count = checkboxes.length;
            var countSpan = document.getElementById('selected-inbounds-count');
            var selectAll = document.getElementById('select-all-inbounds');

            countSpan.textContent = count;

            // Update "select all" checkbox state
            var totalCheckboxes = document.querySelectorAll('.inbound-checkbox').length;
            selectAll.checked = (count === totalCheckboxes);

            // Update warning message
            var countInput = document.getElementById('bulk-count');
            var userCount = parseInt(countInput.value) || 0;
            var totalOps = userCount * count;

            var infoElem = document.getElementById('multi-inbound-info');
            if (totalOps > 5000) {
                infoElem.style.color = 'var(--danger)';
                infoElem.innerHTML = '–í—ã–±—Ä–∞–Ω–æ: <span id="selected-inbounds-count">' + count + '</span> –∏–Ω–±–∞—É–Ω–¥–æ–≤ - ‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π (' + totalOps + ')';
            } else {
                infoElem.style.color = 'var(--success)';
                infoElem.innerHTML = '–í—ã–±—Ä–∞–Ω–æ: <span id="selected-inbounds-count">' + count + '</span> –∏–Ω–±–∞—É–Ω–¥–æ–≤ (–≤—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π: ' + totalOps + ')';
            }
        }

        // Bulk create users
        function bulkCreateUsers(event) {
            event.preventDefault();

            var prefix = document.getElementById('bulk-prefix').value;
            var count = parseInt(document.getElementById('bulk-count').value);
            var traffic = parseInt(document.getElementById('bulk-traffic').value) * 1024 * 1024 * 1024;
            var expiryDays = parseInt(document.getElementById('bulk-expiry-days').value);
            var inboundId = parseInt(document.getElementById('bulk-inbound').value);
            var createInMultiInbounds = document.getElementById('bulk-all-inbounds').checked;

            // –ï—Å–ª–∏ —Å–æ–∑–¥–∞–µ–º –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö inbounds, inboundId –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
            if (!createInMultiInbounds && (!inboundId || isNaN(inboundId))) {
                showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ Inbound –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö inbounds"', 'error');
                return;
            }

            var protocol = null;
            var selectedInbound = null;

            // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –∏–Ω–±–∞—É–Ω–¥–∞
            if (!createInMultiInbounds) {
                selectedInbound = inboundsData.find(function(inbound) {
                    return inbound.id === inboundId;
                });

                if (!selectedInbound) {
                    showToast('–û—à–∏–±–∫–∞: Inbound –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }

                protocol = selectedInbound.protocol.toLowerCase();
            }

            // Calculate expiry time
            var expiryTime = 0;
            if (expiryDays > 0) {
                expiryTime = Date.now() + (expiryDays * 24 * 60 * 60 * 1000);
            }

            // Base template
            var template = {
                name: "Bulk Create",
                prefix: prefix,
                total: traffic,
                expiry_time: expiryTime,
                limitIp: 0
            };

            // Add protocol-specific fields (only for single inbound)
            if (!createInMultiInbounds) {
                if (protocol === 'shadowsocks') {
                    var method = document.getElementById('bulk-method').value;
                    template.method = method;
                } else if (protocol === 'vless') {
                    var flow = document.getElementById('bulk-flow').value;
                    if (flow) {
                        template.flow = flow;
                    }
                }
            }
            // For VMess and Trojan, no additional fields needed (handled by backend)

            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–°–æ–∑–¥–∞—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö inbounds"
            if (createInMultiInbounds) {
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–Ω–±–∞—É–Ω–¥—ã
                var selectedCheckboxes = document.querySelectorAll('.inbound-checkbox:checked');
                var selectedInboundIds = Array.from(selectedCheckboxes).map(function(cb) {
                    return parseInt(cb.value);
                });

                if (selectedInboundIds.length === 0) {
                    showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω inbound', 'error');
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã
                var totalOperations = count * selectedInboundIds.length;
                if (count > 1000) {
                    showToast('–ú–∞–∫—Å–∏–º—É–º 1000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                    return;
                }
                if (totalOperations > 5000) {
                    showToast('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π (' + totalOperations + '). –ú–∞–∫—Å–∏–º—É–º 5000', 'error');
                    return;
                }

                showToast('‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ ' + count + ' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ ' + selectedInboundIds.length + ' inbounds... –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ ' + (selectedInboundIds.length > 1 ? selectedInboundIds.length + ' –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π' : '1 –æ—á–µ—Ä–µ–¥—å'), 'info');

                fetch(API_URL + 'api/users/bulk-create-all-inbounds', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        template: template,
                        count: count,
                        inbound_ids: selectedInboundIds
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.detail || 'Server error');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    showToast('‚úÖ –°–æ–∑–¥–∞–Ω–æ ' + data.queues_count + ' –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π –¥–ª—è ' + count + ' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ ' + selectedInboundIds.length + ' inbounds', 'success');
                    loadQueues(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—á–µ—Ä–µ–¥–µ–π
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('bulk-prefix').value = 'user';
                    document.getElementById('bulk-count').value = '10';
                    document.getElementById('bulk-all-inbounds').checked = false;
                    toggleMultiInboundSelection(); // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
                })
                .catch(error => {
                    console.error('Error creating users:', error);
                    showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + error.message, 'error');
                });

                return;
            }

            // –î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ (>100) –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º—É –æ—á–µ—Ä–µ–¥–µ–π
            if (count > 100) {
                showToast('‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è ' + count + ' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...', 'info');

                fetch(API_URL + 'api/queues/bulk-create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        template: template,
                        count: count,
                        inbound_id: inboundId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    showToast('‚úÖ –û—á–µ—Ä–µ–¥—å —Å–æ–∑–¥–∞–Ω–∞! –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å...', 'success');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—á–µ—Ä–µ–¥–µ–π
                    loadQueues();
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('bulk-prefix').value = 'user';
                    document.getElementById('bulk-count').value = '10';
                })
                .catch(error => {
                    console.error('Error creating queue:', error);
                    showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏', 'error');
                });

                return;
            }

            // –î–ª—è –º–∞–ª—ã—Ö –æ–±—ä–µ–º–æ–≤ (‚â§100) –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ
            showToast('‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ ' + count + ' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...', 'info');

            fetch(API_URL + 'api/users/bulk-create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    template: template,
                    count: count,
                    inbound_id: inboundId
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(err) {
                        throw new Error(err.detail || 'Server error');
                    });
                }
                return response.json();
            })
            .then(function(data) {
                var message = '–°–æ–∑–¥–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + data.created + ' –∏–∑ ' + count;

                if (data.created === 0) {
                    showToast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                    if (data.errors && data.errors.length > 0) {
                        console.error('Errors:', data.errors);
                        alert('–û—à–∏–±–∫–∏:\n' + data.errors.join('\n'));
                    }
                } else if (data.created < count) {
                    showToast('‚ö†Ô∏è ' + message + ' (–µ—Å—Ç—å –æ—à–∏–±–∫–∏)', 'warning');
                    if (data.errors && data.errors.length > 0) {
                        console.error('Errors:', data.errors);
                    }
                } else {
                    showToast('‚úÖ ' + message, 'success');
                }

                loadStats();
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏
                if (data.created > 0) {
                    document.getElementById('bulk-prefix').value = 'user';
                    document.getElementById('bulk-count').value = '10';
                }
            })
            .catch(function(error) {
                console.error('Error creating users:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message, 'error');
            });
        }

        // Load low traffic users
        function loadLowTrafficUsers() {
            var threshold = document.getElementById('low-traffic-threshold').value;
            var sortBy = document.getElementById('low-traffic-sort').value;

            fetch(API_URL + 'api/users/low-traffic?threshold=' + threshold + '&sort_by=' + sortBy)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    lowTrafficUsers = data.users;
                    var tbody = document.getElementById('low-traffic-table-body');
                    if (lowTrafficUsers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="loading">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
                        return;
                    }

                    tbody.innerHTML = lowTrafficUsers.map(function(user) {
                        return '<tr>' +
                            '<td><input type="checkbox" class="checkbox low-traffic-checkbox" value="' + user.id + '"></td>' +
                            '<td>' + user.email + '</td>' +
                            '<td>' + formatBytes(user.up + user.down) + '</td>' +
                            '<td style="color: var(--danger)">' + formatBytes(user.remaining || 0) + '</td>' +
                            '<td>' + formatBytes(user.total) + '</td>' +
                            '</tr>';
                    }).join('');
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                });
        }

        // Update filter description based on selected filter type
        function updateFilterDescription() {
            var filterType = document.getElementById('unlimited-filter-type').value;
            var description = document.getElementById('filter-description');

            var descriptions = {
                'expiry': 'üìå –ë—É–¥—É—Ç –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (expiry_time = 0)',
                'traffic': 'üìå –ë—É–¥—É—Ç –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ (total = 0 –∏–ª–∏ NULL)',
                'both': 'üìå –ë—É–¥—É—Ç –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ë–ï–ó –æ–±–æ–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–±–µ—Å—Å—Ä–æ—á–Ω—ã–µ –ò –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫)'
            };

            description.textContent = descriptions[filterType] || '';
        }

        // Load unlimited users
        function loadUnlimitedUsers() {
            var filterType = document.getElementById('unlimited-filter-type').value;
            var filterSelect = document.getElementById('unlimited-filter-type');
            var filterText = filterSelect.options[filterSelect.selectedIndex].text;
            var limit = parseInt(document.getElementById('unlimited-limit').value) || 0;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            var tbody = document.getElementById('unlimited-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

            // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            var url = API_URL + 'api/users/unlimited?filter_type=' + filterType;
            if (limit > 0) {
                url += '&limit=' + limit;
            }

            fetch(url)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    unlimitedUsers = data.users;

                    // Update status bar
                    var statusBar = document.getElementById('unlimited-status-bar');
                    var activeFilter = document.getElementById('unlimited-active-filter');
                    var resultsCount = document.getElementById('unlimited-results-count');

                    statusBar.style.display = 'block';
                    activeFilter.textContent = filterText;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    var totalCount = data.total || data.count;
                    if (limit > 0 && totalCount > limit) {
                        resultsCount.textContent = data.count + ' –∏–∑ ' + totalCount;
                    } else {
                        resultsCount.textContent = totalCount;
                    }

                    if (unlimitedUsers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="loading">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
                        return;
                    }

                    tbody.innerHTML = unlimitedUsers.map(function(user) {
                        return '<tr>' +
                            '<td><input type="checkbox" class="checkbox unlimited-checkbox" value="' + user.id + '"></td>' +
                            '<td>' + user.email + '</td>' +
                            '<td><span class="badge ' + (user.enable ? 'badge-success' : 'badge-danger') + '">' + (user.enable ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω') + '</span></td>' +
                            '<td>' + formatBytes(user.used_traffic || 0) + '</td>' +
                            '<td>' + formatDate(user.expiry_time) + '</td>' +
                            '</tr>';
                    }).join('');

                    var message = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + data.count;
                    if (totalCount > data.count) {
                        message += ' –∏–∑ ' + totalCount + ' (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö)';
                    }
                    showToast(message, 'success');
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                });
        }

        // Delete selected users
        function deleteSelected() {
            var checkboxes = document.querySelectorAll('.user-checkbox:checked');
            var userIds = [];
            checkboxes.forEach(function(cb) { userIds.push(cb.value); });

            if (userIds.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                return;
            }

            if (!confirm('–£–¥–∞–ª–∏—Ç—å ' + userIds.length + ' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?')) return;

            fetch(API_URL + 'api/users/bulk-delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_ids: userIds})
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                showToast('–£–¥–∞–ª–µ–Ω–æ: ' + data.deleted, 'success');
                loadUsers();
                loadStats();
            })
            .catch(function(error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            });
        }

        // Extend expiry for unlimited users
        function extendUnlimitedExpiry() {
            var checkboxes = document.querySelectorAll('.unlimited-checkbox:checked');
            var userIds = [];
            checkboxes.forEach(function(cb) { userIds.push(cb.value); });
            var days = parseInt(document.getElementById('unlimited-extend-days').value);

            if (userIds.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                return;
            }

            fetch(API_URL + 'api/users/extend-expiry', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_ids: userIds, days: days})
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                showToast('–ü—Ä–æ–¥–ª–µ–Ω–æ: ' + data.updated + ' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ ' + days + ' –¥–Ω–µ–π', 'success');
                loadUnlimitedUsers();
            })
            .catch(function(error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è', 'error');
            });
        }

        // Block unlimited users
        function blockUnlimitedSelected() {
            var checkboxes = document.querySelectorAll('.unlimited-checkbox:checked');
            var userIds = [];
            checkboxes.forEach(function(cb) { userIds.push(cb.value); });

            if (userIds.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                return;
            }

            fetch(API_URL + 'api/users/toggle-status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_ids: userIds, enable: false})
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                showToast('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ' + data.updated, 'success');
                loadUnlimitedUsers();
            })
            .catch(function(error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏', 'error');
            });
        }

        // Reset traffic for unlimited users
        function resetTrafficUnlimited() {
            var checkboxes = document.querySelectorAll('.unlimited-checkbox:checked');
            var userIds = [];
            checkboxes.forEach(function(cb) { userIds.push(cb.value); });

            if (userIds.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                return;
            }

            var newLimit = prompt('–ù–æ–≤—ã–π –ª–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ (GB):', '100');
            if (!newLimit) return;

            fetch(API_URL + 'api/users/reset-traffic', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_ids: userIds,
                    new_limit: parseInt(newLimit) * 1024 * 1024 * 1024
                })
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                showToast('–¢—Ä–∞—Ñ–∏–∫ —Å–±—Ä–æ—à–µ–Ω –¥–ª—è ' + data.updated + ' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ù–æ–≤—ã–π –ª–∏–º–∏—Ç: ' + newLimit + ' GB', 'success');
                loadUnlimitedUsers();
            })
            .catch(function(error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ —Ç—Ä–∞—Ñ–∏–∫–∞', 'error');
            });
        }

        // Add traffic to unlimited users
        function addTrafficUnlimited() {
            var checkboxes = document.querySelectorAll('.unlimited-checkbox:checked');
            var userIds = [];
            checkboxes.forEach(function(cb) { userIds.push(cb.value); });

            if (userIds.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                return;
            }

            var additionalTraffic = prompt('–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ (GB):', '50');
            if (!additionalTraffic) return;

            fetch(API_URL + 'api/users/add-traffic', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_ids: userIds,
                    additional_traffic: parseInt(additionalTraffic) * 1024 * 1024 * 1024
                })
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ ' + additionalTraffic + ' GB –¥–ª—è ' + data.updated + ' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'success');
                loadUnlimitedUsers();
            })
            .catch(function(error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞', 'error');
            });
        }

        // Set traffic limit for unlimited users
        function setLimitUnlimited() {
            var checkboxes = document.querySelectorAll('.unlimited-checkbox:checked');
            var userIds = [];
            checkboxes.forEach(function(cb) { userIds.push(cb.value); });

            if (userIds.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                return;
            }

            var newLimit = prompt('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ (GB):', '100');
            if (!newLimit) return;

            fetch(API_URL + 'api/users/set-limit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_ids: userIds,
                    new_limit: parseInt(newLimit) * 1024 * 1024 * 1024
                })
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                showToast('–õ–∏–º–∏—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ' + newLimit + ' GB –¥–ª—è ' + data.updated + ' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'success');
                loadUnlimitedUsers();
            })
            .catch(function(error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–∏–º–∏—Ç–∞', 'error');
            });
        }

        // Toggle checkboxes
        function toggleAllUsers(checkbox) {
            document.querySelectorAll('.user-checkbox').forEach(function(cb) { cb.checked = checkbox.checked; });
        }

        function toggleAllLowTraffic(checkbox) {
            document.querySelectorAll('.low-traffic-checkbox').forEach(function(cb) { cb.checked = checkbox.checked; });
        }

        function toggleAllUnlimited(checkbox) {
            document.querySelectorAll('.unlimited-checkbox').forEach(function(cb) { cb.checked = checkbox.checked; });
        }

        // Reset traffic
        function resetTrafficSelected() {
            var checkboxes = document.querySelectorAll('.low-traffic-checkbox:checked');
            var userIds = [];
            checkboxes.forEach(function(cb) { userIds.push(cb.value); });

            if (userIds.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                return;
            }

            var newLimit = prompt('–ù–æ–≤—ã–π –ª–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ (GB):', '100');
            if (!newLimit) return;

            fetch(API_URL + 'api/users/reset-traffic', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_ids: userIds,
                    new_limit: parseInt(newLimit) * 1024 * 1024 * 1024
                })
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                showToast('–°–±—Ä–æ—à–µ–Ω–æ: ' + data.updated, 'success');
                loadLowTrafficUsers();
            })
            .catch(function(error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞', 'error');
            });
        }

        // Delete low traffic users
        function deleteLowTrafficSelected() {
            var checkboxes = document.querySelectorAll('.low-traffic-checkbox:checked');
            var userIds = [];
            checkboxes.forEach(function(cb) { userIds.push(cb.value); });

            if (userIds.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                return;
            }

            if (!confirm('–£–¥–∞–ª–∏—Ç—å ' + userIds.length + ' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?')) return;

            fetch(API_URL + 'api/users/bulk-delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_ids: userIds})
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                showToast('–£–¥–∞–ª–µ–Ω–æ: ' + data.deleted, 'success');
                loadLowTrafficUsers();
                loadStats();
            })
            .catch(function(error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            });
        }

        // ==================== SERVER MONITORING ====================

        let monitoringInterval = null;

        async function loadServerMonitoring() {
            try {
                // Load online users
                const onlineResponse = await fetch(API_URL + 'api/monitoring/online-users', {
                    credentials: 'include'
                });
                const onlineData = await onlineResponse.json();
                document.getElementById('online-users-count').textContent = onlineData.online_users || 0;

                // Load server health
                const healthResponse = await fetch(API_URL + 'api/monitoring/health', {
                    credentials: 'include'
                });
                const health = await healthResponse.json();

                // CPU
                document.getElementById('cpu-usage').textContent = health.cpu_percent + '%';
                document.getElementById('cpu-bar').style.width = health.cpu_percent + '%';

                // Memory
                const memoryUsedGB = (health.memory_used / (1024**3)).toFixed(2);
                const memoryTotalGB = (health.memory_total / (1024**3)).toFixed(2);
                document.getElementById('memory-usage').textContent = `${memoryUsedGB} / ${memoryTotalGB} GB`;
                document.getElementById('memory-bar').style.width = health.memory_percent + '%';

                // Disk
                const diskUsedGB = (health.disk_used / (1024**3)).toFixed(2);
                const diskTotalGB = (health.disk_total / (1024**3)).toFixed(2);
                document.getElementById('disk-usage').textContent = `${diskUsedGB} / ${diskTotalGB} GB`;
                document.getElementById('disk-bar').style.width = health.disk_percent + '%';

                // Network
                document.getElementById('network-sent').textContent = formatBytes(health.network_sent);
                document.getElementById('network-recv').textContent = formatBytes(health.network_recv);

                // Uptime
                document.getElementById('server-uptime').textContent = formatUptime(health.uptime_seconds);

            } catch (error) {
                console.error('Error loading monitoring data:', error);
            }
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);

            if (days > 0) {
                return `${days}–¥ ${hours}—á`;
            } else if (hours > 0) {
                return `${hours}—á ${minutes}–º`;
            } else {
                return `${minutes}–º`;
            }
        }

        function startMonitoring() {
            loadServerMonitoring();
            // Update every 5 seconds
            if (monitoringInterval) clearInterval(monitoringInterval);
            monitoringInterval = setInterval(loadServerMonitoring, 5000);
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
        }

        // ==================== QUEUE MANAGEMENT ====================

        let queuePollingInterval = null;

        async function loadQueues() {
            try {
                const response = await fetch(API_URL + 'api/queues', {
                    credentials: 'include'
                });
                const data = await response.json();

                const tbody = document.getElementById('queues-table-body');
                tbody.innerHTML = '';

                if (data.queues && data.queues.length > 0) {
                    data.queues.forEach(queue => {
                        const progress = queue.progress;
                        const percent = progress.total > 0 ? Math.round((progress.completed / progress.total) * 100) : 0;

                        const statusBadge = getQueueStatusBadge(queue.status);
                        const actions = getQueueActions(queue);

                        // Extract metadata
                        const metadata = queue.metadata || {};
                        const inbound = metadata.inbound_remark || '-';
                        const protocol = metadata.protocol || '-';
                        const prefix = metadata.prefix || '-';

                        // Add batch info if multi-inbound
                        const batchInfo = metadata.multi_inbound ?
                            ` <span style="color: #999; font-size: 11px;">(${metadata.batch_number}/${metadata.total_batches_for_inbound})</span>` : '';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><code>${queue.id.substring(0, 8)}...</code></td>
                            <td>${inbound}${batchInfo}</td>
                            <td><span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">${protocol}</span></td>
                            <td><code>${prefix}</code></td>
                            <td>${progress.total}</td>
                            <td>
                                <div style="width: 100%;">
                                    ${progress.completed} / ${progress.total} (${percent}%)
                                    <div style="background: var(--bg-primary); height: 6px; border-radius: 3px; margin-top: 4px; overflow: hidden;">
                                        <div style="background: var(--accent); height: 100%; width: ${percent}%; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                            </td>
                            <td>${statusBadge}</td>
                            <td>${formatDate(queue.created_at)}</td>
                            <td>${actions}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="9">–ù–µ—Ç –æ—á–µ—Ä–µ–¥–µ–π</td></tr>';
                }
            } catch (error) {
                console.error('Error loading queues:', error);
            }
        }

        function getQueueStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge" style="background: rgba(251, 191, 36, 0.2); color: #f59e0b;">–û–∂–∏–¥–∞–Ω–∏–µ</span>',
                'processing': '<span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>',
                'completed': '<span class="badge badge-success">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>',
                'failed': '<span class="badge badge-danger">–û—à–∏–±–∫–∞</span>',
                'cancelled': '<span class="badge" style="background: rgba(156, 163, 175, 0.2); color: #9ca3af;">–û—Ç–º–µ–Ω–µ–Ω–æ</span>'
            };
            return badges[status] || status;
        }

        function getQueueActions(queue) {
            if (queue.status === 'processing' || queue.status === 'pending') {
                return `<button class="btn btn-sm btn-danger" onclick="cancelQueue('${queue.id}')">–û—Ç–º–µ–Ω–∏—Ç—å</button>`;
            } else {
                return `<button class="btn btn-sm btn-secondary" onclick="deleteQueue('${queue.id}')">–£–¥–∞–ª–∏—Ç—å</button>`;
            }
        }

        async function cancelQueue(queueId) {
            if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –æ—á–µ—Ä–µ–¥—å?')) {
                return;
            }

            try {
                const response = await fetch(API_URL + `api/queues/${queueId}/cancel`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('–û—á–µ—Ä–µ–¥—å –æ—Ç–º–µ–Ω–µ–Ω–∞', 'success');
                    loadQueues();
                } else {
                    showToast('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –æ—á–µ—Ä–µ–¥–∏', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –æ—á–µ—Ä–µ–¥–∏', 'error');
            }
        }

        async function deleteQueue(queueId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—á–µ—Ä–µ–¥—å?')) {
                return;
            }

            try {
                const response = await fetch(API_URL + `api/queues/${queueId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('–û—á–µ—Ä–µ–¥—å —É–¥–∞–ª–µ–Ω–∞', 'success');
                    loadQueues();
                } else {
                    showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏', 'error');
            }
        }

        function startQueuePolling() {
            loadQueues();
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
            if (queuePollingInterval) clearInterval(queuePollingInterval);
            queuePollingInterval = setInterval(loadQueues, 3000);
        }

        function stopQueuePolling() {
            if (queuePollingInterval) {
                clearInterval(queuePollingInterval);
                queuePollingInterval = null;
            }
        }

        // ==================== API TOKEN MANAGEMENT ====================

        async function generateToken() {
            const tokenName = document.getElementById('token-name').value.trim();

            if (!tokenName) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞', 'error');
                return;
            }

            try {
                const response = await fetch(API_URL + 'api/tokens/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name: tokenName })
                });

                const data = await response.json();

                if (response.ok) {
                    // Display the new token
                    document.getElementById('new-token-value').textContent = data.token;
                    document.getElementById('token-display').style.display = 'block';
                    document.getElementById('token-name').value = '';

                    // Store token in hidden field for copying
                    window.currentToken = data.token;
                } else {
                    showToast(data.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞', 'error');
            }
        }

        function copyToken() {
            const tokenValue = window.currentToken;
            navigator.clipboard.writeText(tokenValue).then(() => {
                showToast('–¢–æ–∫–µ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
            }).catch(() => {
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω', 'error');
            });
        }

        function closeTokenDisplay() {
            document.getElementById('token-display').style.display = 'none';
            window.currentToken = null;
            loadTokens();
        }

        async function loadTokens() {
            try {
                const response = await fetch(API_URL + 'api/tokens', {
                    credentials: 'include'
                });
                const data = await response.json();

                const tbody = document.getElementById('tokens-table-body');
                tbody.innerHTML = '';

                if (data.tokens && data.tokens.length > 0) {
                    data.tokens.forEach(token => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${escapeHtml(token.name)}</td>
                            <td><code>${escapeHtml(token.token_preview)}</code></td>
                            <td>${formatDate(token.created_at)}</td>
                            <td>${token.last_used ? formatDate(token.last_used) : '–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è'}</td>
                            <td>
                                <span class="badge ${token.active ? 'badge-success' : 'badge-danger'}">
                                    ${token.active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Ç–æ–∑–≤–∞–Ω'}
                                </span>
                            </td>
                            <td>
                                ${token.active ?
                                    `<button class="btn btn-sm btn-warning" onclick="revokeToken('${token.full_token}')">–û—Ç–æ–∑–≤–∞—Ç—å</button>` :
                                    ''}
                                <button class="btn btn-sm btn-danger" onclick="deleteToken('${token.full_token}')">–£–¥–∞–ª–∏—Ç—å</button>
                                <button class="btn btn-sm btn-secondary" onclick="copyFullToken('${token.full_token}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6">–ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤</td></tr>';
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤', 'error');
            }
        }

        async function revokeToken(token) {
            if (!confirm('–û—Ç–æ–∑–≤–∞—Ç—å —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω? –û–Ω –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.')) {
                return;
            }

            try {
                const response = await fetch(API_URL + `api/tokens/${encodeURIComponent(token)}/revoke`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('–¢–æ–∫–µ–Ω –æ—Ç–æ–∑–≤–∞–Ω', 'success');
                    loadTokens();
                } else {
                    showToast('–û—à–∏–±–∫–∞ –æ—Ç–∑—ã–≤–∞ —Ç–æ–∫–µ–Ω–∞', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –æ—Ç–∑—ã–≤–∞ —Ç–æ–∫–µ–Ω–∞', 'error');
            }
        }

        async function deleteToken(token) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }

            try {
                const response = await fetch(API_URL + `api/tokens/${encodeURIComponent(token)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('–¢–æ–∫–µ–Ω —É–¥–∞–ª–µ–Ω', 'success');
                    loadTokens();
                } else {
                    showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞', 'error');
            }
        }

        function copyFullToken(token) {
            navigator.clipboard.writeText(token).then(() => {
                showToast('–¢–æ–∫–µ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success');
            }).catch(() => {
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'error');
            });
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== VERSION & UPDATE MANAGEMENT ====================

        async function loadVersion() {
            try {
                const response = await fetch(API_URL + 'api/system/version', {
                    credentials: 'include'
                });
                const data = await response.json();

                document.getElementById('version-info').textContent =
                    `‚öôÔ∏è ${data.version_name} v${data.current_version}`;

                // Auto-check for updates on load
                checkForUpdates(false);
            } catch (error) {
                console.error('Error loading version:', error);
                document.getElementById('version-info').textContent = '‚öôÔ∏è –í–µ—Ä—Å–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
            }
        }

        async function checkForUpdates(showLoading = true) {
            const updateButtons = document.getElementById('update-buttons');
            const updateStatus = document.getElementById('update-status');

            try {
                const response = await fetch(API_URL + 'api/system/update/check?force=' + showLoading, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.update_available) {
                    // Show update button only when update available
                    updateButtons.style.display = 'flex';
                    document.getElementById('new-version').textContent = data.latest_version;
                    updateStatus.textContent = `‚ú® v${data.latest_version} –¥–æ—Å—Ç—É–ø–Ω–∞`;

                    if (showLoading) {
                        showToast(`–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: ${data.latest_version}`, 'info');
                    }
                } else {
                    // Hide update section when no update
                    updateButtons.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking updates:', error);
                updateButtons.style.display = 'none';
            }
        }

        let updateProgressInterval = null;

        function showUpdateModal() {
            document.getElementById('update-progress-modal').style.display = 'flex';
            // Reset UI
            document.getElementById('update-progress-bar').style.width = '0%';
            document.getElementById('update-progress-bar').textContent = '0%';
            document.getElementById('update-progress-stage').textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';
            document.getElementById('update-progress-message').textContent = '–ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...';
            document.getElementById('update-success-message').style.display = 'none';
            document.getElementById('update-error-message').style.display = 'none';
            document.getElementById('close-update-modal-btn').style.display = 'none';
        }

        function closeUpdateModal() {
            document.getElementById('update-progress-modal').style.display = 'none';
            if (updateProgressInterval) {
                clearInterval(updateProgressInterval);
                updateProgressInterval = null;
            }
        }

        function updateProgressUI(progress) {
            const progressBar = document.getElementById('update-progress-bar');
            const stageElem = document.getElementById('update-progress-stage');
            const messageElem = document.getElementById('update-progress-message');

            // Update progress bar
            progressBar.style.width = progress.progress + '%';
            progressBar.textContent = progress.progress + '%';

            // Update stage message
            const stageNames = {
                'checking': 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π',
                'backup': 'üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏',
                'downloading': '‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è',
                'extracting': 'üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤',
                'installing': '‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤',
                'dependencies': 'üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π',
                'restarting': 'üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞',
                'completed': '‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ',
                'failed': '‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è',
                'idle': '‚è∏Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ'
            };

            stageElem.textContent = stageNames[progress.status] || progress.status;
            messageElem.textContent = progress.message || '';
        }

        async function pollUpdateStatus() {
            try {
                const response = await fetch(API_URL + 'api/system/update/status', {
                    credentials: 'include'
                });

                // Ignore 502/401 errors during service restart
                if (response.status === 502 || response.status === 401) {
                    // Service is restarting, continue polling
                    console.log('Service restarting (502/401), will retry...');
                    return;
                }

                if (!response.ok) return;

                const data = await response.json();
                const progress = data.progress;

                updateProgressUI(progress);

                // Check if completed or failed
                if (progress.status === 'completed') {
                    clearInterval(updateProgressInterval);
                    document.getElementById('update-success-message').style.display = 'block';

                    // Countdown and reload
                    let countdown = 5;
                    const countdownElem = document.getElementById('reload-countdown');
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        countdownElem.textContent = countdown;
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            window.location.reload();
                        }
                    }, 1000);

                } else if (progress.status === 'failed') {
                    clearInterval(updateProgressInterval);
                    document.getElementById('update-error-message').textContent = '‚ùå –û—à–∏–±–∫–∞: ' + progress.message;
                    document.getElementById('update-error-message').style.display = 'block';
                    document.getElementById('close-update-modal-btn').style.display = 'inline-block';
                }

            } catch (error) {
                // Network errors during restart are expected
                console.log('Polling error (service restarting):', error.message);
                // Continue polling, don't show error
            }
        }

        async function performUpdate() {
            if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç —Å–µ—Ä–≤–∏—Å.\n–í—ã –ø–æ—Ç–µ—Ä—è–µ—Ç–µ —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é –∏ –¥–æ–ª–∂–Ω—ã –±—É–¥–µ—Ç–µ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
            }

            const updateBtn = document.getElementById('perform-update-btn');
            updateBtn.disabled = true;
            updateBtn.innerHTML = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';

            // Show progress modal
            showUpdateModal();

            try {
                // Start update
                const response = await fetch(API_URL + 'api/system/update', {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    // Start polling for progress
                    updateProgressInterval = setInterval(pollUpdateStatus, 2000);  // Poll every 2 seconds
                    pollUpdateStatus();  // Poll immediately

                } else {
                    // Show error
                    document.getElementById('update-error-message').textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + (data.error || data.detail || 'Unknown error');
                    document.getElementById('update-error-message').style.display = 'block';
                    document.getElementById('close-update-modal-btn').style.display = 'inline-block';

                    updateBtn.disabled = false;
                    updateBtn.innerHTML = '‚¨ÜÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –¥–æ <span id="new-version"></span>';
                }
            } catch (error) {
                console.error('Error starting update:', error);
                document.getElementById('update-error-message').textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
                document.getElementById('update-error-message').style.display = 'block';
                document.getElementById('close-update-modal-btn').style.display = 'inline-block';

                updateBtn.disabled = false;
                updateBtn.innerHTML = '‚¨ÜÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –¥–æ <span id="new-version"></span>';
            }
        }

        // ==================== EXPIRED USERS MANAGEMENT ====================

        async function loadExpiredUsers() {
            try {
                const response = await fetch(API_URL + 'api/users/expired', {
                    credentials: 'include'
                });
                const data = await response.json();

                const tbody = document.getElementById('expired-table-body');
                tbody.innerHTML = '';

                if (data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        const expiredDate = user.expiry_time > 0 ? new Date(user.expiry_time).toLocaleString() : '–ù/–î';
                        const used = formatBytes(user.up + user.down);
                        const status = user.enable ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="checkbox" class="checkbox user-checkbox-expired" value="${user.id}"></td>
                            <td>${user.email}</td>
                            <td>${user.inbound_id}</td>
                            <td>${expiredDate}</td>
                            <td>${used}</td>
                            <td><span class="badge ${user.enable ? 'badge-success' : 'badge-danger'}">${status}</span></td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6">–ù–µ—Ç –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
                }
            } catch (error) {
                console.error('Error loading expired users:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        }

        async function loadDisabledUsers() {
            try {
                const response = await fetch(API_URL + 'api/users/disabled', {
                    credentials: 'include'
                });
                const data = await response.json();

                const tbody = document.getElementById('disabled-table-body');
                tbody.innerHTML = '';

                if (data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        const expiryDate = user.expiry_time > 0 ? new Date(user.expiry_time).toLocaleString() : '–ë–µ—Å—Å—Ä–æ—á–Ω–æ';
                        const used = formatBytes(user.up + user.down);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="checkbox" class="checkbox user-checkbox-disabled" value="${user.id}"></td>
                            <td>${user.email}</td>
                            <td>${user.inbound_id}</td>
                            <td>${expiryDate}</td>
                            <td>${used}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5">–ù–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
                }
            } catch (error) {
                console.error('Error loading disabled users:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        }

        function toggleAllExpired(checkbox) {
            const checkboxes = document.querySelectorAll('.user-checkbox-expired');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        function toggleAllDisabled(checkbox) {
            const checkboxes = document.querySelectorAll('.user-checkbox-disabled');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        async function deleteExpiredSelected() {
            const checkboxes = document.querySelectorAll('.user-checkbox-expired:checked');
            const userIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (userIds.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                return;
            }

            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${userIds.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?`)) {
                return;
            }

            try {
                const response = await fetch(API_URL + 'api/users/bulk-delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ user_ids: userIds })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ –£–¥–∞–ª–µ–Ω–æ: ${data.deleted} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`, 'success');
                    loadExpiredUsers();
                } else {
                    showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.detail, 'error');
                }
            } catch (error) {
                console.error('Error deleting users:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        }

        async function deleteAllExpired() {
            try {
                const response = await fetch(API_URL + 'api/users/expired', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.users.length === 0) {
                    showToast('–ù–µ—Ç –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'info');
                    return;
                }

                if (!confirm(`–£–¥–∞–ª–∏—Ç—å –í–°–ï ${data.users.length} –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?`)) {
                    return;
                }

                const userIds = data.users.map(u => u.id);

                const deleteResponse = await fetch(API_URL + 'api/users/bulk-delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ user_ids: userIds })
                });

                const deleteData = await deleteResponse.json();

                if (deleteResponse.ok) {
                    showToast(`‚úÖ –£–¥–∞–ª–µ–Ω–æ: ${deleteData.deleted} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`, 'success');
                    loadExpiredUsers();
                } else {
                    showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + deleteData.detail, 'error');
                }
            } catch (error) {
                console.error('Error deleting all expired:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        }

        async function deleteDisabledSelected() {
            const checkboxes = document.querySelectorAll('.user-checkbox-disabled:checked');
            const userIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (userIds.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                return;
            }

            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${userIds.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?`)) {
                return;
            }

            try {
                const response = await fetch(API_URL + 'api/users/bulk-delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ user_ids: userIds })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ –£–¥–∞–ª–µ–Ω–æ: ${data.deleted} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`, 'success');
                    loadDisabledUsers();
                } else {
                    showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.detail, 'error');
                }
            } catch (error) {
                console.error('Error deleting users:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        }

        async function deleteAllDisabled() {
            try {
                const response = await fetch(API_URL + 'api/users/disabled', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.users.length === 0) {
                    showToast('–ù–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'info');
                    return;
                }

                if (!confirm(`–£–¥–∞–ª–∏—Ç—å –í–°–ï ${data.users.length} –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?`)) {
                    return;
                }

                const userIds = data.users.map(u => u.id);

                const deleteResponse = await fetch(API_URL + 'api/users/bulk-delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ user_ids: userIds })
                });

                const deleteData = await deleteResponse.json();

                if (deleteResponse.ok) {
                    showToast(`‚úÖ –£–¥–∞–ª–µ–Ω–æ: ${deleteData.deleted} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`, 'success');
                    loadDisabledUsers();
                } else {
                    showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + deleteData.detail, 'error');
                }
            } catch (error) {
                console.error('Error deleting all disabled:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        }

        function showEnableModal() {
            const checkboxes = document.querySelectorAll('.user-checkbox-disabled:checked');
            if (checkboxes.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è', 'error');
                return;
            }
            document.getElementById('enable-modal').style.display = 'flex';
        }

        function closeEnableModal() {
            document.getElementById('enable-modal').style.display = 'none';
        }

        async function confirmEnableUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox-disabled:checked');
            const userIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            const expiryDays = parseInt(document.getElementById('enable-expiry-days').value) || 0;
            const trafficGB = parseInt(document.getElementById('enable-traffic-gb').value) || 0;

            closeEnableModal();
            showToast('‚è≥ –í–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...', 'info');

            const expiryTime = expiryDays > 0 ? Date.now() + (expiryDays * 24 * 60 * 60 * 1000) : 0;
            const trafficBytes = trafficGB * 1024 * 1024 * 1024;

            let enabled = 0;
            let updated = 0;

            for (const userId of userIds) {
                try {
                    // 1. Enable user
                    const enableResponse = await fetch(API_URL + `api/users/${userId}/toggle`, {
                        method: 'PUT',
                        credentials: 'include'
                    });

                    if (enableResponse.ok) {
                        enabled++;

                        // 2. Set expiry time if specified
                        if (expiryDays >= 0) {
                            await fetch(API_URL + `api/users/${userId}/expiry`, {
                                method: 'PUT',
                                headers: {'Content-Type': 'application/json'},
                                credentials: 'include',
                                body: JSON.stringify({ expiry_days: expiryDays })
                            });
                        }

                        // 3. Set traffic limit if specified
                        if (trafficGB > 0) {
                            await fetch(API_URL + `api/users/${userId}/traffic`, {
                                method: 'PUT',
                                headers: {'Content-Type': 'application/json'},
                                credentials: 'include',
                                body: JSON.stringify({ traffic_limit: trafficBytes })
                            });
                        }

                        updated++;
                    }
                } catch (error) {
                    console.error('Error enabling user:', error);
                }
            }

            showToast(`‚úÖ –í–∫–ª—é—á–µ–Ω–æ: ${enabled}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${updated} –∏–∑ ${userIds.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`, 'success');
            loadDisabledUsers();
        }

        // ==================== SSL CERTIFICATE MANAGEMENT ====================

        function showSSLModal() {
            document.getElementById('ssl-progress-modal').style.display = 'flex';
            document.getElementById('ssl-progress-message').style.display = 'block';
            document.getElementById('ssl-success-message').style.display = 'none';
            document.getElementById('ssl-error-message').style.display = 'none';
            document.getElementById('close-ssl-modal-btn').style.display = 'none';
        }

        function closeSSLModal() {
            document.getElementById('ssl-progress-modal').style.display = 'none';
        }

        async function loadSSLStatus() {
            try {
                const response = await fetch(API_URL + 'api/ssl/status', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    const cert = data.certificate;

                    // Update domain
                    document.getElementById('ssl-domain').textContent = data.domain || '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω';

                    if (cert.has_certificate) {
                        // Status with color
                        const statusElem = document.getElementById('ssl-status');
                        if (cert.is_expired) {
                            statusElem.textContent = '‚ùå –ò—Å—Ç—ë–∫';
                            statusElem.style.color = 'var(--danger)';
                        } else if (cert.needs_renewal) {
                            statusElem.textContent = '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
                            statusElem.style.color = 'var(--warning)';
                        } else {
                            statusElem.textContent = '‚úÖ –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω';
                            statusElem.style.color = 'var(--success)';
                        }

                        // Days until expiry
                        const daysElem = document.getElementById('ssl-days-left');
                        daysElem.textContent = cert.days_until_expiry !== null ? cert.days_until_expiry : '-';
                        if (cert.days_until_expiry < 0) {
                            daysElem.style.color = 'var(--danger)';
                        } else if (cert.days_until_expiry < 30) {
                            daysElem.style.color = 'var(--warning)';
                        } else {
                            daysElem.style.color = 'var(--success)';
                        }

                        // Expiry date
                        if (cert.not_after) {
                            const expiryDate = new Date(cert.not_after);
                            document.getElementById('ssl-expiry-date').textContent = expiryDate.toLocaleDateString('ru-RU', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        } else {
                            document.getElementById('ssl-expiry-date').textContent = '-';
                        }

                        // Certificate details
                        const details = `
–î–æ–º–µ–Ω: ${data.domain || 'N/A'}
–°—Ç–∞—Ç—É—Å: ${cert.status}
–ü—É—Ç—å –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É: ${cert.cert_path || 'N/A'}
–ü—É—Ç—å –∫ –∫–ª—é—á—É: ${cert.key_path || 'N/A'}
–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω —Å: ${cert.not_before ? new Date(cert.not_before).toLocaleString('ru-RU') : 'N/A'}
–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: ${cert.not_after ? new Date(cert.not_after).toLocaleString('ru-RU') : 'N/A'}
–î–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è: ${cert.days_until_expiry !== null ? cert.days_until_expiry : 'N/A'}
–¢—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${cert.needs_renewal ? '–î–∞' : '–ù–µ—Ç'}
Subject: ${cert.subject || 'N/A'}
                        `.trim();
                        document.getElementById('ssl-cert-details').textContent = details;

                    } else {
                        document.getElementById('ssl-status').textContent = '‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω';
                        document.getElementById('ssl-status').style.color = 'var(--warning)';
                        document.getElementById('ssl-days-left').textContent = '-';
                        document.getElementById('ssl-expiry-date').textContent = '-';
                        document.getElementById('ssl-cert-details').textContent = cert.message || '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω';
                    }
                } else {
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ SSL: ' + (data.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error loading SSL status:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ SSL', 'error');
            }
        }

        async function renewSSLCertificate(force = false) {
            const confirmMsg = force
                ? '‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞?\n\n–≠—Ç–æ –æ–±–Ω–æ–≤–∏—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –µ—â—ë –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç Nginx –∏ 3x-ui.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?'
                : 'üîê –û–±–Ω–æ–≤–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç?\n\n–≠—Ç–æ –æ–±–Ω–æ–≤–∏—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —á–µ—Ä–µ–∑ Let\'s Encrypt (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è) –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç —Å–µ—Ä–≤–∏—Å—ã.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?';

            if (!confirm(confirmMsg)) {
                return;
            }

            showSSLModal();
            document.getElementById('ssl-progress-message').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —á–µ—Ä–µ–∑ Let\'s Encrypt...';

            try {
                const response = await fetch(API_URL + 'api/ssl/renew?force=' + force, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                document.getElementById('ssl-progress-message').style.display = 'none';

                if (data.success) {
                    const successElem = document.getElementById('ssl-success-message');
                    if (data.renewed) {
                        successElem.innerHTML = '‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!<br><small>' + (data.message || '') + '</small>';
                    } else {
                        successElem.innerHTML = '‚ÑπÔ∏è ' + (data.message || '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è');
                    }
                    successElem.style.display = 'block';
                    showToast('SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
                    loadSSLStatus();
                } else {
                    const errorElem = document.getElementById('ssl-error-message');
                    errorElem.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (data.message || 'Unknown error');
                    errorElem.style.display = 'block';
                    showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSL: ' + (data.message || 'Unknown'), 'error');
                }

                document.getElementById('close-ssl-modal-btn').style.display = 'inline-block';

            } catch (error) {
                console.error('Error renewing SSL:', error);
                document.getElementById('ssl-progress-message').style.display = 'none';
                const errorElem = document.getElementById('ssl-error-message');
                errorElem.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
                errorElem.style.display = 'block';
                document.getElementById('close-ssl-modal-btn').style.display = 'inline-block';
                showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSL', 'error');
            }
        }

        async function update3xuiCertificate() {
            if (!confirm('–û–±–Ω–æ–≤–∏—Ç—å –ø—É—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –≤ –ø–∞–Ω–µ–ª–∏ 3x-ui?\n\n–≠—Ç–æ –æ–±–Ω–æ–≤–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 3x-ui –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ Let\'s Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç —Å–µ—Ä–≤–∏—Å—ã.')) {
                return;
            }

            try {
                const response = await fetch(API_URL + 'api/ssl/update-3xui', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ 3x-ui –æ–±–Ω–æ–≤–ª—ë–Ω, —Å–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã', 'success');
                    loadSSLStatus();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.message || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('Error updating 3x-ui certificate:', error);
                showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è 3x-ui', 'error');
            }
        }

        async function restartSSLServices() {
            if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Nginx –∏ 3x-ui?\n\n–≠—Ç–æ –ø—Ä–∏–º–µ–Ω–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.')) {
                return;
            }

            try {
                const response = await fetch(API_URL + 'api/ssl/restart-services', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    const services = data.services;
                    let msg = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:\n';
                    msg += `‚Ä¢ Nginx: ${services.nginx.success ? '‚úÖ' : '‚ùå'} ${services.nginx.message}\n`;
                    msg += `‚Ä¢ 3x-ui: ${services['x-ui'].success ? '‚úÖ' : '‚ùå'} ${services['x-ui'].message}`;
                    showToast(msg, services.nginx.success && services['x-ui'].success ? 'success' : 'warning');
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.message || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('Error restarting services:', error);
                showToast('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤', 'error');
            }
        }

        // ==================== EXPIRED USERS EXTENSION ====================

        function showExtendExpiredModal() {
            document.getElementById('extend-expired-modal').style.display = 'flex';
        }

        function closeExtendExpiredModal() {
            document.getElementById('extend-expired-modal').style.display = 'none';
        }

        async function extendExpiredUsers() {
            const checkboxes = document.querySelectorAll('#expired-table-body input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è', 'warning');
                return;
            }

            const days = parseInt(document.getElementById('extend-expiry-days').value) || 30;
            const resetTraffic = document.getElementById('extend-reset-traffic').value === 'yes';

            const userIds = Array.from(checkboxes).map(cb => cb.value);
            await processExtendUsers(userIds, days, resetTraffic);
            closeExtendExpiredModal();
        }

        async function extendAllExpiredUsers() {
            if (!confirm('–ü—Ä–æ–¥–ª–∏—Ç—å –í–°–ï–• –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?')) return;

            const days = parseInt(document.getElementById('extend-expiry-days').value) || 30;
            const resetTraffic = document.getElementById('extend-reset-traffic').value === 'yes';

            // Get all expired user IDs
            const rows = document.querySelectorAll('#expired-table-body tr');
            const userIds = [];
            rows.forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox) userIds.push(checkbox.value);
            });

            if (userIds.length === 0) {
                showToast('–ù–µ—Ç –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'warning');
                return;
            }

            await processExtendUsers(userIds, days, resetTraffic);
            closeExtendExpiredModal();
        }

        async function processExtendUsers(userIds, days, resetTraffic) {
            let extended = 0;
            let errors = 0;
            const total = userIds.length;

            // Show progress
            const tbody = document.getElementById('expired-table-body');
            const progressHtml = `<tr><td colspan="6" style="text-align: center; padding: 20px;">
                <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <br><br>
                <span id="extend-progress" style="color: var(--accent);">–ü—Ä–æ–¥–ª–µ–Ω–∏–µ: 0/${total}</span>
            </td></tr>`;
            tbody.innerHTML = progressHtml;

            for (const id of userIds) {
                try {
                    // Update progress
                    document.getElementById('extend-progress').textContent = `–ü—Ä–æ–¥–ª–µ–Ω–∏–µ: ${extended + 1}/${total}`;

                    // Extend expiry
                    const expiryResponse = await fetch(API_URL + 'api/users/extend-expiry', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify({user_ids: [id], days: days})
                    });

                    // Enable user
                    await fetch(API_URL + `api/users/${id}/toggle`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify({enable: true})
                    });

                    // Reset traffic if needed
                    if (resetTraffic) {
                        await fetch(API_URL + 'api/users/reset-traffic', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            credentials: 'include',
                            body: JSON.stringify({user_ids: [id]})
                        });
                    }

                    extended++;
                } catch (error) {
                    console.error('Error extending user:', error);
                    errors++;
                }
            }

            showToast(`‚úÖ –ü—Ä–æ–¥–ª–µ–Ω–æ: ${extended}, –æ—à–∏–±–æ–∫: ${errors}`, extended > 0 ? 'success' : 'error');
            loadExpiredUsers();
        }

        // ==================== X-UI CONTROL ====================

        let panelUrl = ':54321/panel/';

        async function loadXuiStatus() {
            try {
                const response = await fetch(API_URL + 'api/server/info', {credentials: 'include'});
                const info = await response.json();

                const statusElem = document.getElementById('xui-service-status');
                if (info.xui_installed) {
                    statusElem.textContent = '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω';
                    statusElem.style.color = 'var(--success)';
                } else {
                    statusElem.textContent = '‚ùå –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                    statusElem.style.color = 'var(--danger)';
                }

                document.getElementById('xui-version').textContent = info.xui_version || '-';
                document.getElementById('xray-version').textContent = info.xray_version || '-';
                document.getElementById('tcp-connections').textContent = info.tcp_connections || '0';

                if (info.panel_url) {
                    panelUrl = info.panel_url;
                }

            } catch (error) {
                console.error('Error loading X-UI status:', error);
            }
        }

        function openPanel() {
            const host = window.location.hostname;
            window.open(`https://${host}/esmars/panel/`, '_blank');
        }

        async function runSpeedtest() {
            const resultDiv = document.getElementById('speedtest-result');
            resultDiv.innerHTML = '<span style="color: var(--accent);">üöÄ –ó–∞–ø—É—Å–∫ speedtest (–¥–æ 2 –º–∏–Ω—É—Ç)...</span>';

            try {
                const response = await fetch(API_URL + 'api/server/speedtest', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;">
                            ‚¨áÔ∏è Download: <strong>${data.download} Mbps</strong> |
                            ‚¨ÜÔ∏è Upload: <strong>${data.upload} Mbps</strong> |
                            üèì Ping: <strong>${data.ping} ms</strong>
                            <br><small style="color: var(--text-secondary);">Server: ${data.server}</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.message}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: var(--danger);">‚ùå –û—à–∏–±–∫–∞ speedtest</span>';
            }
        }

        async function regenerateKeys() {
            if (!confirm('‚ö†Ô∏è –≠—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ù–û–í–´–ï UUID/–ø–∞—Ä–æ–ª–∏ –¥–ª—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!\n\n–í—Å–µ —Ç–µ–∫—É—â–∏–µ –∫–ª—é—á–∏ –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;

            try {
                const response = await fetch(API_URL + 'api/users/regenerate-keys', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(`‚úÖ ${data.message}`, 'success');
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + data.message, 'error');
                }
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π', 'error');
            }
        }

        async function applySNI() {
            const sni = prompt('–í–≤–µ–¥–∏—Ç–µ SNI –¥–æ–º–µ–Ω –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ –≤—Å–µ–º Reality inbounds:', 'www.google.com');
            if (!sni) return;

            try {
                const response = await fetch(API_URL + `api/inbounds/apply-sni?sni=${encodeURIComponent(sni)}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(`‚úÖ ${data.message}`, 'success');
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + data.message, 'error');
                }
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SNI', 'error');
            }
        }

        async function xuiAction(action) {
            if (!confirm(`${action === 'restart' ? '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å' : action === 'stop' ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å'} x-ui?`)) return;

            try {
                const response = await fetch(API_URL + `api/system/xui/${action}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ X-UI: ${action}`, 'success');
                    setTimeout(loadXuiStatus, 2000);
                } else {
                    showToast(`–û—à–∏–±–∫–∞: ${data.detail || 'Unknown'}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã', 'error');
            }
        }

        async function loadXuiLogs(type) {
            try {
                const response = await fetch(API_URL + `api/system/logs?type=${type}&lines=100`, {
                    credentials: 'include'
                });
                const data = await response.json();
                document.getElementById('xui-logs').textContent = data.logs || '–õ–æ–≥–∏ –ø—É—Å—Ç—ã';
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('xui-logs').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤';
            }
        }

        function clearXuiLogs() {
            document.getElementById('xui-logs').textContent = '–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã';
        }

        async function updateDatFiles() {
            if (!confirm('–û–±–Ω–æ–≤–∏—Ç—å GeoIP –∏ GeoSite —Ñ–∞–π–ª—ã?\n\n–≠—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.')) return;

            showToast('‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ dat —Ñ–∞–π–ª–æ–≤...', 'info');

            try {
                const response = await fetch(API_URL + 'api/system/update-dat', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('‚úÖ Dat —Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.message || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è dat —Ñ–∞–π–ª–æ–≤', 'error');
            }
        }

        async function updateXray() {
            if (!confirm('–û–±–Ω–æ–≤–∏—Ç—å Xray –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏?')) return;

            try {
                const response = await fetch(API_URL + 'api/system/xray/update', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (response.ok) {
                    showToast('‚úÖ Xray –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                    loadXuiStatus();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.detail || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Xray', 'error');
            }
        }

        // ==================== INBOUND MANAGEMENT ====================

        async function loadInboundsTable() {
            const tbody = document.getElementById('inbounds-table-body');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

            try {
                const response = await fetch(API_URL + 'api/inbounds', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.inbounds && data.inbounds.length > 0) {
                    tbody.innerHTML = data.inbounds.map(ib => `
                        <tr>
                            <td>${ib.id}</td>
                            <td><strong>${ib.remark || '-'}</strong></td>
                            <td><span style="background: var(--accent); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${ib.protocol}</span></td>
                            <td>${ib.port}</td>
                            <td>${ib.enable ? '<span style="color: var(--success);">‚úÖ –í–∫–ª</span>' : '<span style="color: var(--danger);">‚ùå –í—ã–∫–ª</span>'}</td>
                            <td>${ib.users_count || 0}</td>
                            <td>
                                <div class="btn-group" style="gap: 4px;">
                                    <button class="btn btn-primary" style="padding: 4px 8px; font-size: 11px;" onclick="editInbound(${ib.id})">‚úèÔ∏è</button>
                                    <button class="btn ${ib.enable ? 'btn-warning' : 'btn-success'}" style="padding: 4px 8px; font-size: 11px;" onclick="toggleInbound(${ib.id})">${ib.enable ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</button>
                                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="deleteInbound(${ib.id}, '${ib.remark}')">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">–ù–µ—Ç inbounds</td></tr>';
                }
            } catch (error) {
                console.error('Error:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--danger);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
            }
        }

        async function editInbound(id) {
            try {
                const response = await fetch(API_URL + `api/inbounds/${id}/full`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success && data.inbound) {
                    const ib = data.inbound;
                    document.getElementById('edit-inbound-id').value = id;
                    document.getElementById('edit-inbound-remark').value = ib.remark || '';
                    document.getElementById('edit-inbound-port').value = ib.port || '';
                    document.getElementById('edit-inbound-protocol').value = ib.protocol || '';
                    document.getElementById('edit-inbound-enable').value = ib.enable ? '1' : '0';

                    // Format JSON fields
                    document.getElementById('edit-inbound-stream').value =
                        ib.stream_settings ? JSON.stringify(ib.stream_settings, null, 2) : '';
                    document.getElementById('edit-inbound-settings').value =
                        ib.settings ? JSON.stringify(ib.settings, null, 2) : '';
                    document.getElementById('edit-inbound-sniffing').value =
                        ib.sniffing ? JSON.stringify(ib.sniffing, null, 2) : '';

                    document.getElementById('inbound-modal-title').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ${ib.remark}`;
                    document.getElementById('inbound-edit-modal').style.display = 'flex';
                } else {
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ inbound', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ inbound', 'error');
            }
        }

        function closeInboundModal() {
            document.getElementById('inbound-edit-modal').style.display = 'none';
        }

        async function saveInbound() {
            const id = document.getElementById('edit-inbound-id').value;

            // Parse JSON fields
            let streamSettings, settings, sniffing;
            try {
                const streamText = document.getElementById('edit-inbound-stream').value.trim();
                streamSettings = streamText ? JSON.parse(streamText) : null;
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞ –≤ Stream Settings JSON', 'error');
                return;
            }

            try {
                const settingsText = document.getElementById('edit-inbound-settings').value.trim();
                settings = settingsText ? JSON.parse(settingsText) : null;
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞ –≤ Settings JSON', 'error');
                return;
            }

            try {
                const sniffingText = document.getElementById('edit-inbound-sniffing').value.trim();
                sniffing = sniffingText ? JSON.parse(sniffingText) : null;
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞ –≤ Sniffing JSON', 'error');
                return;
            }

            const data = {
                remark: document.getElementById('edit-inbound-remark').value,
                port: parseInt(document.getElementById('edit-inbound-port').value),
                enable: parseInt(document.getElementById('edit-inbound-enable').value),
                stream_settings: streamSettings,
                settings: settings,
                sniffing: sniffing
            };

            try {
                const response = await fetch(API_URL + `api/inbounds/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    showToast('‚úÖ Inbound —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
                    closeInboundModal();
                    loadInboundsTable();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (result.message || result.detail), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            }
        }

        async function toggleInbound(id) {
            try {
                const response = await fetch(API_URL + `api/inbounds/${id}/toggle`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadInboundsTable();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.message || data.detail), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }

        async function deleteInbound(id, name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å inbound "${name}"?\n\n‚ö†Ô∏è –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —ç—Ç–æ–≥–æ inbound –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!`)) return;

            try {
                const response = await fetch(API_URL + `api/inbounds/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(`‚úÖ ${data.message}`, 'success');
                    loadInboundsTable();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.message || data.detail), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            }
        }

        // ==================== SNI SCANNER ====================

        async function discoverSNI() {
            const provider = document.getElementById('sni-provider').value;
            const count = parseInt(document.getElementById('sni-discover-count').value) || 20;
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ –ü–æ–∏—Å–∫...';

            const tbody = document.getElementById('sni-results-body');
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 30px;">
                <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <br><br>
                <span style="color: var(--accent);">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ${provider.toUpperCase()} IP –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤...</span><br>
                <small style="color: var(--text-secondary);">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è ${count} IP –∞–¥—Ä–µ—Å–æ–≤. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥.</small>
            </td></tr>`;

            // Add spin animation if not exists
            if (!document.getElementById('spin-style')) {
                const style = document.createElement('style');
                style.id = 'spin-style';
                style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
                document.head.appendChild(style);
            }

            try {
                const response = await fetch(API_URL + `api/sni/discover?provider=${provider}&count=${count}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                btn.disabled = false;
                btn.innerHTML = 'üöÄ –ù–∞–π—Ç–∏';

                if (data.results && data.results.length > 0) {
                    tbody.innerHTML = data.results.map(r => `
                        <tr>
                            <td><strong>${r.domain}</strong><br><small style="color: var(--text-secondary);">${r.ip}</small></td>
                            <td>‚úÖ</td>
                            <td>‚úÖ</td>
                            <td>${r.latency}ms</td>
                            <td style="color: var(--success);">‚úÖ OK</td>
                            <td>
                                <button class="btn btn-success" style="padding: 3px 6px; font-size: 10px;" onclick="saveSNI('${r.domain}', ${r.latency})">üíæ</button>
                            </td>
                        </tr>
                    `).join('');
                    showToast(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${data.found} –¥–æ–º–µ–Ω–æ–≤ –∏–∑ ${data.scanned} IP`, 'success');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--warning);">–î–æ–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä.</td></tr>';
                }
            } catch (error) {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ –ù–∞–π—Ç–∏';
                console.error('Error:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--danger);">–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message + '</td></tr>';
            }
        }

        async function testSingleSNI() {
            const domain = document.getElementById('sni-single-domain').value.trim();
            if (!domain) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω', 'error');
                return;
            }

            const resultDiv = document.getElementById('sni-single-result');
            resultDiv.innerHTML = '<span style="color: var(--accent);">‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</span>';

            try {
                const response = await fetch(API_URL + `api/sni/test?domain=${encodeURIComponent(domain)}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.error) {
                    resultDiv.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.error}</span>`;
                } else {
                    const tls = data.tls_version === 'TLSv1.3' ? '‚úÖ' : '‚ö†Ô∏è';
                    const h2 = data.h2_support ? '‚úÖ' : '‚ùå';
                    resultDiv.innerHTML = `
                        <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;">
                            <div><strong>${domain}</strong></div>
                            <div style="margin-top: 8px;">
                                ${tls} TLS: ${data.tls_version || '-'} |
                                ${h2} H2: ${data.h2_support ? '–î–∞' : '–ù–µ—Ç'} |
                                ‚è±Ô∏è ${data.latency_ms}ms
                            </div>
                            ${data.tls_version === 'TLSv1.3' && data.h2_support ?
                                `<button class="btn btn-success" style="margin-top: 8px; padding: 4px 8px; font-size: 11px;" onclick="saveSNI('${domain}', ${data.latency_ms})">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = '<span style="color: var(--danger);">‚ùå –û—à–∏–±–∫–∞</span>';
            }
        }

        async function loadSNISuggestions() {
            try {
                const response = await fetch(API_URL + 'api/sni/suggestions', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.suggestions) {
                    document.getElementById('sni-domains-list').value = data.suggestions.join('\n');
                    showToast('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –¥–æ–º–µ–Ω—ã', 'success');
                }
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
            }
        }

        async function scanSNIDomains() {
            const domainsText = document.getElementById('sni-domains-list').value.trim();
            if (!domainsText) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω—ã –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                return;
            }

            const domains = domainsText.split('\n').map(d => d.trim()).filter(d => d);
            if (domains.length === 0) return;

            const tbody = document.getElementById('sni-results-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;"><span style="color: var(--accent);">‚è≥ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ' + domains.length + ' –¥–æ–º–µ–Ω–æ–≤...</span></td></tr>';

            try {
                const response = await fetch(API_URL + 'api/sni/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ domains: domains })
                });
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    tbody.innerHTML = data.results.map(r => {
                        const statusColor = r.status === 'ok' ? 'var(--success)' : r.status === 'partial' ? 'var(--warning)' : 'var(--danger)';
                        const statusText = r.status === 'ok' ? '‚úÖ OK' : r.status === 'partial' ? '‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ' : '‚ùå –û—à–∏–±–∫–∞';
                        return `
                            <tr>
                                <td><strong>${r.domain}</strong></td>
                                <td>${r.tls13 ? '‚úÖ' : '‚ùå'}</td>
                                <td>${r.h2 ? '‚úÖ' : '‚ùå'}</td>
                                <td>${r.latency ? r.latency + 'ms' : '-'}</td>
                                <td style="color: ${statusColor};">${statusText}</td>
                                <td>
                                    ${r.status === 'ok' ? `<button class="btn btn-success" style="padding: 3px 6px; font-size: 10px;" onclick="saveSNI('${r.domain}', ${r.latency})">üíæ</button>` : ''}
                                </td>
                            </tr>
                        `;
                    }).join('');
                    showToast(`–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${data.results.filter(r => r.status === 'ok').length} –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö`, 'success');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</td></tr>';
                }
            } catch (error) {
                console.error('Error:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--danger);">–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</td></tr>';
            }
        }

        async function saveSNI(domain, latency) {
            try {
                const response = await fetch(API_URL + `api/sni/save?domain=${encodeURIComponent(domain)}&latency=${latency || 0}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(`‚úÖ ${domain} —Å–æ—Ö—Ä–∞–Ω–µ–Ω`, 'success');
                    loadSavedSNI();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + data.message, 'error');
                }
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            }
        }

        async function loadSavedSNI() {
            try {
                const response = await fetch(API_URL + 'api/sni/saved', {
                    credentials: 'include'
                });
                const data = await response.json();

                const list = document.getElementById('sni-saved-list');
                if (data.domains && data.domains.length > 0) {
                    list.innerHTML = data.domains.map(d => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border);">
                            <span><strong>${d.domain}</strong> <span style="color: var(--text-secondary);">${d.latency ? d.latency + 'ms' : ''}</span></span>
                            <button class="btn btn-danger" style="padding: 2px 6px; font-size: 10px;" onclick="deleteSavedSNI('${d.domain}')">üóëÔ∏è</button>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<span style="color: var(--text-secondary);">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤</span>';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function deleteSavedSNI(domain) {
            try {
                const response = await fetch(API_URL + `api/sni/saved/${encodeURIComponent(domain)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(`${domain} —É–¥–∞–ª–µ–Ω`, 'success');
                    loadSavedSNI();
                }
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            }
        }

        // ==================== FINGERPRINT MANAGEMENT ====================

        async function loadFingerprints() {
            const info = document.getElementById('fingerprint-info');
            info.innerHTML = '<span style="color: var(--accent);">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</span>';

            try {
                const response = await fetch(API_URL + 'api/inbounds/fingerprints', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success && data.inbounds.length > 0) {
                    let html = '<div style="margin-top: 10px;"><strong>–¢–µ–∫—É—â–∏–µ fingerprints:</strong></div>';
                    html += '<div style="margin-top: 8px; max-height: 150px; overflow-y: auto;">';
                    data.inbounds.forEach(ib => {
                        html += `<div style="padding: 4px 0; border-bottom: 1px solid var(--border);">
                            <span style="color: var(--text-primary);">${ib.remark}</span>
                            <span style="color: var(--text-secondary);"> (${ib.protocol}/${ib.security})</span>:
                            <span style="color: var(--accent); font-weight: 500;">${ib.fingerprint}</span>
                        </div>`;
                    });
                    html += '</div>';
                    info.innerHTML = html;
                } else if (data.inbounds && data.inbounds.length === 0) {
                    info.innerHTML = '<span style="color: var(--warning);">‚ö†Ô∏è –ù–µ—Ç inbounds —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π fingerprint (TLS/Reality)</span>';
                } else {
                    info.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.message || '–û—à–∏–±–∫–∞'}</span>`;
                }
            } catch (error) {
                console.error('Error:', error);
                info.innerHTML = '<span style="color: var(--danger);">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span>';
            }
        }

        async function updateFingerprints() {
            const fingerprint = document.getElementById('fingerprint-select').value;
            if (!confirm(`–û–±–Ω–æ–≤–∏—Ç—å fingerprint –Ω–∞ –≤—Å–µ—Ö inbounds?\n\n–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${fingerprint}\n\nX-UI –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω.`)) return;

            const info = document.getElementById('fingerprint-info');
            info.innerHTML = '<span style="color: var(--accent);">‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</span>';

            try {
                const response = await fetch(API_URL + `api/inbounds/fingerprints/update?fingerprint=${fingerprint}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${data.updated_count} inbounds`, 'success');
                    info.innerHTML = `<span style="color: var(--success);">‚úÖ Fingerprint –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ ${data.updated_count} inbounds</span>`;
                    loadXuiStatus();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.message || 'Unknown'), 'error');
                    info.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.message || '–û—à–∏–±–∫–∞'}</span>`;
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è fingerprint', 'error');
                info.innerHTML = '<span style="color: var(--danger);">‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</span>';
            }
        }

        // ==================== SYSTEM OPTIMIZATION ====================

        async function checkSystemOptimization() {
            try {
                const response = await fetch(API_URL + 'api/system/optimization/check', {
                    credentials: 'include'
                });
                const data = await response.json();

                // Update status cards
                const bbrStatus = document.getElementById('bbr-status');
                if (data.bbr_enabled) {
                    bbrStatus.textContent = '‚úÖ ' + (data.bbr_version || 'Enabled');
                    bbrStatus.style.color = 'var(--success)';
                } else {
                    bbrStatus.textContent = '‚ùå –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                    bbrStatus.style.color = 'var(--danger)';
                }

                const tcpStatus = document.getElementById('tcp-status');
                if (data.tcp_optimized) {
                    tcpStatus.textContent = '‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω';
                    tcpStatus.style.color = 'var(--success)';
                } else {
                    tcpStatus.textContent = '‚ö†Ô∏è –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π';
                    tcpStatus.style.color = 'var(--warning)';
                }

                document.getElementById('kernel-version').textContent = data.kernel || '-';

                // Show detailed results
                let results = `–í–µ—Ä—Å–∏—è —è–¥—Ä–∞: ${data.kernel || 'N/A'}\n`;
                results += `BBR: ${data.bbr_enabled ? '‚úÖ –í–∫–ª—é—á–µ–Ω' : '‚ùå –í—ã–∫–ª—é—á–µ–Ω'}\n`;
                results += `–í–µ—Ä—Å–∏—è BBR: ${data.bbr_version || 'N/A'}\n`;
                results += `TCP –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: ${data.tcp_optimized ? '‚úÖ' : '‚ùå'}\n\n`;
                results += `–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n${data.sysctl_values || 'N/A'}`;

                document.getElementById('system-check-results').textContent = results;

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('system-check-results').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã';
            }
        }

        async function installBBR() {
            if (!confirm('‚ö†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å BBR3?\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞.')) return;

            showToast('‚è≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ BBR3...', 'info');

            try {
                const response = await fetch(API_URL + 'api/system/optimization/install-bbr', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('‚úÖ BBR —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. ' + (data.message || ''), 'success');
                    checkSystemOptimization();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.message || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ BBR', 'error');
            }
        }

        async function optimizeTCP() {
            if (!confirm('–ü—Ä–∏–º–µ–Ω–∏—Ç—å TCP –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏?')) return;

            try {
                const response = await fetch(API_URL + 'api/system/optimization/tcp', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('‚úÖ TCP –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                    checkSystemOptimization();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.message || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ TCP', 'error');
            }
        }

        async function installAllOptimizations() {
            if (!confirm('‚ö†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏?\n\nBBR3 + TCP –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏. –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞.')) return;

            showToast('‚è≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π...', 'info');

            try {
                const response = await fetch(API_URL + 'api/system/optimization/install-all', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('‚úÖ –í—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                    checkSystemOptimization();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.message || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏', 'error');
            }
        }

        // ==================== INITIALIZATION ====================

        // Initialize
        window.onload = function() {
            loadStats();
            loadInbounds();
            loadUsers();
            loadVersion();  // Load version info
            loadInboundsTable();  // Load inbounds table
            loadXuiStatus();  // Load X-UI status
            loadExpiredUsers();  // Load expired users
            loadDisabledUsers();  // Load disabled users

            // Refresh stats every 30 seconds
            setInterval(loadStats, 30000);

            // Check for updates every 6 hours
            setInterval(() => checkForUpdates(false), 6 * 60 * 60 * 1000);
        };
    </script>
</body>
</html>
